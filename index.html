<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>LINE 自動登入 + 授權檢查</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    .result { margin-top: 1em; padding: 1em; border: 1px solid #ccc; white-space: pre-wrap; }
    button { padding: 0.6em 1em; font-size: 1em; }
  </style>
</head>
<body>
  <h2>LINE 登入測試</h2>
  <button onclick="loginWithLine()">使用 LINE 登入</button>

  <div class="result" id="result">尚未登入</div>

  <script>
    // ===== 配置 =====
    const LINE_CHANNEL_ID = "你的 LINE Channel ID"; // 換成你在 LINE Developers 建的 Channel ID
    const REDIRECT_URI = window.location.origin + window.location.pathname; // 自己這頁
    const GAS_URL = "你的 GAS 部署網址"; // 換成你實際的 GAS Web App URL
    const SCOPE = "openid profile"; // 需要 email 就加上 email
    const STATE = Math.random().toString(36).substring(2);

    // ===== 登入流程 =====
    function loginWithLine() {
      const authUrl =
        "https://access.line.me/oauth2/v2.1/authorize" +
        `?response_type=token%20id_token` +
        `&client_id=${LINE_CHANNEL_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&state=${STATE}` +
        `&scope=${encodeURIComponent(SCOPE)}` +
        `&nonce=${STATE}`;
      window.location.href = authUrl;
    }

    // ===== 檢查 URL Hash (LINE redirect 回來會帶 access_token, id_token) =====
    window.onload = () => {
      const hash = window.location.hash.substr(1);
      if (!hash) return;
      const params = new URLSearchParams(hash);

      const idToken = params.get("id_token");
      if (!idToken) return;

      const payload = parseJwt(idToken);
      const userId = payload.sub;
      const name = payload.name;

      document.getElementById("result").innerText =
        `LINE 登入成功！\n使用者：${name}\nuserId: ${userId}\n\n正在檢查授權...`;

      checkAuth(userId);
    };

    // ===== 呼叫 GAS API 檢查授權 =====
    async function checkAuth(userId) {
      try {
        const resp = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId })
        });
        const data = await resp.json();
        document.getElementById("result").innerText +=
          "\n\n授權檢查結果：\n" + JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById("result").innerText += "\n\n檢查失敗：" + err;
      }
    }

    // ===== 解碼 JWT (id_token) =====
    function parseJwt(token) {
      const base64Url = token.split(".")[1];
      const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
      const jsonPayload = decodeURIComponent(atob(base64).split("").map(function(c) {
        return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(""));
      return JSON.parse(jsonPayload);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å½¥å½¬ğŸŒ¿è©¦ç®—ç³»çµ±ï¼ˆé©—è­‰ç‰ˆï¼‰</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- å¼•å…¥LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root {
    --bg-color: #0f0f0f;
    --panel-bg: #1a1a1a;
    --text-color: #e0e0e0;
    --accent: #00d1b2;
    --highlight: #40c4ff;
    --error: #ff5252;
    --button-green: #00bfa5;
    --button-grey: #3a3a3a;
    --warning: #ff9800;
    --super-admin: #d4af37; /* è¶…çº§ç®¡ç†å‘˜é‡‘è‰² */
    --vip-admin: #00bfa5;   /* å°Šçˆµç”¨æˆ·ç»¿è‰² */
    --gradient-primary: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
    --gradient-secondary: linear-gradient(145deg, #2d2d2d, #1f1f1f);
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    --loader-color: #00d1b2;
  }

  * {
    box-sizing: border-box;
  }

  body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: 'Segoe UI', 'Noto Sans TC', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
    margin: 0;
    padding: 10px;
    line-height: 1.5;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* é«˜è³ªæ„Ÿé©—è­‰åŠ è¼‰å®¹å™¨ */
  #authContainer {
    width: 100%;
    max-width: 400px;
    margin: 50px auto;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #authLoading {
    width: 100%;
    background: var(--gradient-secondary);
    border-radius: 16px;
    padding: 40px 25px;
    text-align: center;
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.5s ease;
  }

  /* åŠ è¼‰å‹•ç•« */
  .loader {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--loader-color);
    border-radius: 50%;
    animation: spin 1s linear infinite, pulse 2s ease-in-out infinite alternate;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes pulse {
    from {
      box-shadow: 0 0 15px rgba(0, 209, 178, 0.3);
    }
    to {
      box-shadow: 0 0 25px rgba(0, 209, 178, 0.6);
    }
  }

  #authLoading h3 {
    margin: 0 0 8px 0;
    font-size: 1.2rem;
    color: var(--highlight);
    font-weight: 600;
  }

  #authLoading p {
    margin: 0;
    font-size: 0.95rem;
    color: #bbb;
    line-height: 1.6;
  }

  /* æ¬Šé™æç¤ºæ¬„ */
  #authStatusBar {
    background: var(--gradient-secondary);
    padding: 12px 18px;
    border-radius: 12px;
    margin-bottom: 20px;
    font-size: 14px;
    text-align: center;
    border: 1px solid rgba(0, 209, 178, 0.3);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    display: none;
    width: 100%;
    max-width: 600px;
  }

  #authStatusBar .super-admin {
    color: var(--super-admin);
    font-weight: bold;
  }

  #authStatusBar .vip-admin {
    color: var(--vip-admin);
    font-weight: bold;
  }

  #authStatusBar .normal {
    color: var(--highlight);
    font-weight: bold;
  }

  #authStatusBar .expired {
    color: var(--error);
    font-weight: bold;
  }

  #captureArea {
    background: linear-gradient(145deg, #1c1c1c, #141414);
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.05),
                0 4px 20px rgba(0, 0, 0, 0.6);
    color: var(--text-color);
    padding: 15px 10px;
    border-radius: 12px;
    margin-bottom: 15px;
    overflow-x: auto;
    display: none; /* åˆå§‹éš±è—ï¼Œé©—è­‰é€šéå¾Œé¡¯ç¤º */
    width: 100%;
    max-width: 600px;
  }

  /* å¢å¤§æ¨™é¡Œå­—é«”ä¸¦ç¢ºä¿å±…ä¸­ */
  #captureArea h2 {
    text-align: center;
    font-size: 2rem; /* åŸºç¤å­—é«”æ›´å¤§ */
    font-weight: bold;
    color: #ffffff;
    margin: 0 0 15px 0;
    padding: 10px 0; /* å¢åŠ å…§é‚Šè· */
    line-height: 1.3;
    width: 100%; /* ç¢ºä¿å…¨å¯¬ */
  }

  @media (min-width: 768px) {
    #captureArea h2 {
      font-size: 2.4rem; /* å¤§å±å¹•å­—é«”æ›´å¤§ */
    }
  }

  .userInputs {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
  }

  .userInputs .row {
    display: flex;
    gap: 10px;
    width: 100%;
  }

  .userInputs label {
    flex: 1;
    display: flex;
    flex-direction: column;
    font-size: 14px;
    color: #bbb;
  }

  .userInputs label span {
    text-align: center;
    margin-bottom: 4px;
    font-size: 15px;
  }

  .userInputs input {
    padding: 10px;
    font-size: 16px;
    background: #333;
    color: var(--text-color);
    border: none;
    border-radius: 6px;
    width: 100%;
    box-sizing: border-box;
    text-align: center;
  }

  .calculator-container {
    display: flex;
    gap: 5px;
  }

  #resetCalculatorBtn {
    padding: 10px;
    background-color: var(--button-grey);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    flex-shrink: 0;
    width: 40px;
  }

  #resetCalculatorBtn:hover {
    background-color: #555;
  }

  #nameInput option {
    padding: 12px 10px;
    line-height: 1.6;
    font-size: 16px;
    height: auto;
    white-space: normal;
  }

  #reportTable {
    width: 100%;
    min-width: 300px;
    border-collapse: collapse;
    font-size: 12px;
    border-radius: 10px;
    overflow: hidden;
    background-color: #f9fafb;
    color: #374151;
    margin: 0 auto;
  }

  #reportTable th:nth-child(1),
  #reportTable td:nth-child(1) { width: 22%; }
  #reportTable th:nth-child(2),
  #reportTable td:nth-child(2) { width: 10%; }
  #reportTable th:nth-child(3),
  #reportTable td:nth-child(3) { width: 12%; }
  #reportTable th:nth-child(4),
  #reportTable td:nth-child(4) { width: 12%; }
  #reportTable th:nth-child(5),
  #reportTable td:nth-child(5) { width: 16%; }
  #reportTable th:nth-child(6),
  #reportTable td:nth-child(6) { width: 16%; }
  #reportTable th:nth-child(7),
  #reportTable td:nth-child(7) { width: 12%; }

  #reportTable th,
  #reportTable td {
    border: 1px solid #d1d5db;
    padding: 6px 4px;
    text-align: center;
    white-space: nowrap;
    transition: all 0.3s ease;
  }

  #reportTable th:nth-child(2),
  #reportTable td:nth-child(2),
  .qtySelect {
    font-size: 16px !important;
    font-weight: bold !important;
  }

  #reportTable td:nth-child(3),
  #reportTable td:nth-child(4),
  #reportTable td:nth-child(5),
  #reportTable td:nth-child(6) {
    font-weight: 500;
    text-align: center !important;
  }

  @media (min-width: 768px) {
    #reportTable th,
    #reportTable td {
      padding: 8px 5px;
      font-size: 14px;
    }
    
    #reportTable th:nth-child(2),
    #reportTable td:nth-child(2),
    .qtySelect,
    #qtyInput {
      font-size: 18px !important;
    }
  }

  #reportTable thead {
    background: linear-gradient(90deg, #2b6cb0, #3182ce);
    color: #fff;
    font-weight: 600;
  }

  #reportTable tbody tr:nth-child(odd) { background-color: #f3f4f6; }
  #reportTable tbody tr:nth-child(even) { background-color: #e5e7eb; }

  #reportTable tbody tr:hover {
    background-color: #1e88e5;
    color: #fff;
    font-weight: bold;
    transform: scale(1.01);
  }

  .deleteBtn {
    writing-mode: vertical-rl;
    text-orientation: upright;
    background-color: var(--error);
    border: none;
    color: white;
    border-radius: 4px;
    padding: 2px;
    cursor: pointer;
    font-size: 11px;
    display: inline-block;
    height: auto;
    width: auto;
    margin: 0 auto;
  }

  .summaryBox {
    text-align: center;
    margin-top: 13px;
    font-size: 1rem;
    font-weight: bold;
    color: var(--highlight);
    line-height: 1.6;
  }

  .summaryBox .extra {
    display: block;
    font-size: 0.9rem;
    color: var(--accent);
    margin-top: 4px;
  }

  .summaryBox .done {
    color: #4caf50;
    font-weight: bold;
  }

  #totalPriceCellDup, #totalPvCellDup, #pvDiff, #pvDiff2 {
    display: inline-block;
    min-width: 60px;
    text-align: center;
  }

  #inputArea {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
    display: none; /* åˆå§‹éš±è—ï¼Œé©—è­‰é€šéå¾Œé¡¯ç¤º */
    width: 100%;
    max-width: 600px;
  }

  @media (min-width: 576px) {
    #inputArea {
      flex-direction: row;
      align-items: center;
    }
  }

  #nameInput,
  #qtyInput,
  #addBtn {
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
  }

  #qtyInput {
    font-size: 18px !important;
    font-weight: bold;
  }

  #nameInput,
  #qtyInput {
    background-color: #2c2c2c;
    color: var(--text-color);
    flex: 1;
    text-align: center;
  }

  #addBtn,
  #exportBtn,
  #shareToLineBtn,
  #nativeShareBtn,
  #clearImageBtn,
  #resetReportBtn {
    background: linear-gradient(145deg, #00bfa5, #009e8a);
    box-shadow: 0 4px 8px rgba(0, 191, 165, 0.3);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    font-size: 15px;
  }

  #addBtn:hover,
  #exportBtn:hover,
  #shareToLineBtn:hover,
  #nativeShareBtn:hover,
  #resetReportBtn:hover {
    background: linear-gradient(145deg, #00ccb2, #00a98e);
    transform: translateY(-2px);
  }

  #addBtn:disabled,
  #exportBtn:disabled,
  #shareToLineBtn:disabled {
    background: var(--button-grey);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  #addBtn {
    width: 100%;
  }

  @media (min-width: 576px) {
    #addBtn {
      width: 120px;
    }
  }

  .button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin: 10px 0;
    display: none; /* åˆå§‹éš±è—ï¼Œé©—è­‰é€šéå¾Œé¡¯ç¤º */
    width: 100%;
    max-width: 600px;
  }

  #exportBtn,
  #shareToLineBtn,
  #nativeShareBtn,
  #clearImageBtn,
  #resetReportBtn {
    flex: 1;
    min-width: 110px;
    margin: 0;
    padding: 10px 0;
    font-size: 15px;
    border-radius: 8px;
  }

  #clearImageBtn {
    background: var(--button-grey);
  }

  #clearImageBtn:hover {
    background: #555;
  }

  #clearImageBtn:disabled {
    background: #2a2a2a;
    cursor: not-allowed;
  }

  #resetReportBtn {
    background: #ff9800;
  }

  #resetReportBtn:hover {
    background: #ffa726;
  }

  #resetReportBtn:disabled {
    background: #b36a00;
    cursor: not-allowed;
  }

  #previewImage {
    display: none;
    max-width: 100%;
    border: 2px solid #888;
    border-radius: 10px;
    margin: 15px auto;
    max-width: 600px;
  }

  #shareToLineBtn,
  #nativeShareBtn,
  #clearImageBtn {
    display: none;
  }

  #buyerInput,
  #calculatorDisplay {
    background-color: #f9fafb;
    border: 1.5px solid #d1d5db;
    color: #374151;
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 16px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    box-sizing: border-box;
    font-weight: 500;
  }

  @media (min-width: 768px) {
    #buyerInput,
    #calculatorDisplay {
      font-size: 18px;
    }
  }

  #buyerInput:focus {
    border-color: #2563eb;
    box-shadow: 0 0 8px 2px rgba(37, 99, 235, 0.3);
    outline: none;
    background-color: #ffffff;
  }

  #calculatorDisplay {
    background-color: #e9ecef;
    cursor: default;
  }

  #buyerInput::placeholder {
    color: #9ca3af;
    font-weight: 400;
    text-align: center;
  }

  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--gradient-secondary);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    opacity: 0;
    transition: opacity 0.5s ease, transform 0.5s ease;
    z-index: 1000;
    text-align: center;
    min-width: 200px;
    font-size: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-10px);
  }

  .toast.error {
    background: linear-gradient(145deg, #4a0000, #2a0000);
    border-color: rgba(255, 82, 82, 0.3);
  }

  .toast.warning {
    background: linear-gradient(145deg, #4a3200, #2a1e00);
    border-color: rgba(255, 152, 0, 0.3);
  }

  .payment-options {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 8px;
    color: white;
    font-size: 1.1rem;
    flex-wrap: wrap;
  }

  .payment-options label {
    display: flex;
    align-items: center;
    gap: 8px;
    color: white;
    font-weight: 500;
  }

  .payment-options input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }

  @media print {
    body {
      background: #fff;
      color: #000;
    }

    #authContainer,
    #authLoading,
    #authStatusBar,
    #inputArea,
    #addBtn,
    #exportBtn,
    #shareToLineBtn,
    #clearImageBtn,
    #nativeShareBtn,
    #resetCalculatorBtn,
    #resetReportBtn {
      display: none !important;
    }

    #captureArea {
      box-shadow: none;
      background: #fff;
      color: #000;
      display: block !important;
    }

    #reportTable th {
      background: #ccc !important;
      color: #000 !important;
    }

    .deleteBtn {
      display: none !important;
    }

    .summaryBox {
      color: #000 !important;
    }
    
    #reportTable td, #reportTable th {
      text-align: center !important;
    }
    
    #reportTable th:nth-child(2),
    #reportTable td:nth-child(2) {
      font-size: 16px !important;
      font-weight: bold !important;
    }
  }

  .spacer {
    height: 80px;
  }

  @media (max-width: 360px) {
    .userInputs .row {
      gap: 5px;
    }
    
    .userInputs label {
      font-size: 13px;
    }
    
    .userInputs input {
      font-size: 15px;
      padding: 8px;
    }
    
    #reportTable {
      font-size: 11px;
    }
    
    #reportTable th:nth-child(2),
    #reportTable td:nth-child(2),
    .qtySelect,
    #qtyInput {
      font-size: 15px !important;
    }
    
    .payment-options {
      font-size: 1rem;
    }

    #authStatusBar {
      font-size: 12px;
    }

    #authLoading {
      padding: 30px 20px;
    }

    .loader {
      width: 40px;
      height: 40px;
    }
  }

  /* é«˜è³ªæ„ŸéŒ¯èª¤æç¤ºæ¨£å¼ */
  #error-message {
    display: none;
    background: linear-gradient(145deg, #4a0000, #2a0000);
    border: 1px solid rgba(255, 82, 82, 0.3);
    color: #fef2f2;
    padding: 20px;
    border-radius: 16px;
    margin: 20px auto;
    max-width: 400px;
    text-align: center;
    box-shadow: var(--card-shadow);
  }

  #error-message #error-content {
    margin-bottom: 15px;
  }

  #error-message button {
    background: linear-gradient(145deg, #ff5252, #d32f2f);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 10px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  #error-message button:hover {
    background: linear-gradient(145deg, #ff6b6b, #e53935);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 82, 82, 0.3);
  }
</style>
</head>
<body>
  <!-- é«˜è³ªæ„Ÿé©—è­‰å®¹å™¨ -->
  <div id="authContainer">
    <!-- éŒ¯èª¤æç¤ºï¼ˆé«˜è³ªæ„Ÿæ¨£å¼ï¼‰ -->
    <div id="error-message">
      <div id="error-content"></div>
    </div>

    <!-- é©—è­‰åŠ è¼‰æç¤ºï¼ˆé«˜è³ªæ„Ÿï¼‰ -->
    <div id="authLoading">
      <div class="loader"></div>
      <h3>æ­£åœ¨é©—è­‰ç”¨æˆ¶æ¬Šé™</h3>
      <p>è«‹ç¨å€™...</p>
    </div>
  </div>

  <!-- æ¬Šé™ç‹€æ…‹æ¬„ -->
  <div id="authStatusBar" style="display: none;"></div>

  <div id="captureArea">
    <h2>
      ğŸŒ¿ åº·åœ’è©¦ç®—å ±è¡¨
      <div class="payment-options">
        <label><input type="checkbox" id="cashOption" /> ç¾é‡‘</label>
        <label><input type="checkbox" id="cardOption" /> åˆ·å¡</label>
      </div>
    </h2>
    <div class="userInputs">  
      <div class="row">
        <label>
          <span>è³¼è²·è€…ï¼š</span>
          <input type="text" placeholder="è¼¸å…¥è³¼è²·è€…" id="buyerInput" />
        </label>
        <label>
          <span>è©¦ç®—è€…ï¼š</span>
          <div class="calculator-container">
            <input type="text" id="calculatorDisplay" readonly />
            <button id="resetCalculatorBtn" title="é‡ç½®è©¦ç®—è€…åç¨±">â†º</button>
          </div>
        </label>
      </div>
    </div>

    <table id="reportTable" aria-label="è©¦ç®—å ±è¡¨">
      <thead>
        <tr>
          <th>å“é …åç¨±</th>
          <th>æ•¸é‡</th>
          <th>å–®åƒ¹</th>
          <th>PV</th>
          <th>å°è¨ˆé‡‘é¡</th>
          <th>å°è¨ˆPV</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>

    <div class="summaryBox" aria-live="polite">
      ç¸½ é‡‘é¡ï¼š<span id="totalPriceCellDup">0</span>ï½œç¸½ PVï¼š<span id="totalPvCellDup">0</span>
      <span class="extra">è· 11.2è¬ PVï¼š<span id="pvDiff">112000</span> <span id="pvMessage1"></span></span>
      <span class="extra">è· 22.0è¬ PVï¼š<span id="pvDiff2">220000</span> <span id="pvMessage2"></span></span>
    </div>
  </div>

  <img id="previewImage" alt="é è¦½åŒ¯å‡ºåœ–ç‰‡" />
  
  <div class="button-group">
    <button id="exportBtn">ğŸ“¤ å ±è¡¨è½‰åœ–ç‰‡</button>
    <button id="shareToLineBtn">ğŸ“© ä¸Šå‚³å‚™ä»½</button>
    <button id="nativeShareBtn">ğŸ“± åˆ†äº«åœ–ç‰‡</button>
    <button id="clearImageBtn">âŒ æ¸…é™¤åœ–ç‰‡</button>
    <button id="resetReportBtn">ğŸ”„ é‡ç½®å ±è¡¨</button>
  </div>

  <div id="toast" class="toast">âœ… åœ–ç‰‡å·²ä¸Šå‚³å‚™ä»½</div>

  <div id="inputArea">
    <select id="nameInput"></select>
    <select id="qtyInput"></select>
    <button id="addBtn">â• æ–°å¢å“é …</button>
  </div>

  <div class="spacer"></div>

  <script>
    // é…ç½®åƒæ•¸ï¼ˆèˆ‡å¾Œç«¯å®Œå…¨å°é½Šï¼‰
    const API_URL = "https://script.google.com/macros/s/AKfycbyETFQSpvVF0zCq24jLNkGD_lfm6yX44JUpW4cgkTyt3pJsg4G-38_uRbRzMl5xyMPs/exec";
    const IMGBB_API_KEY = "5be146133d1fa6ded66878aade98880f"; // è‹¥å¾ŒçºŒä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥API Keyæ˜¯å¦æœ‰æ•ˆ
    const LIFF_ID = "2007434020-Kf98vapi"; // å°æ‡‰GASå¾Œç«¯çš„LIFF ID
    const JSONP_TIMEOUT = 12000;
    const PERMANENT_EXPIRY_DATE = "9999/12/31";
    const TARGET_PV112 = 112000; // èˆ‡å¾Œç«¯å°é½Š
    const TARGET_PV220 = 220000; // èˆ‡å¾Œç«¯å°é½Š

    // å…¨å±€è®Šé‡
    let allProducts = [];
    let selectedProducts = [];
    let lineName = '';
    let userInfo = null; // ç”¨æˆ¶ä¿¡æ¯ { userId, displayName }
    let authStatus = null; // æ¬Šé™ç‹€æ…‹ { isVip, isSuperAdmin, remainingDays, expiryDate, usageCount, remainingTimes, isExpired }
    let userUsageRecord = JSON.parse(localStorage.getItem('userUsageRecord')) || {}; // æœ¬åœ°ä½¿ç”¨è¨˜éŒ„

    // DOMå…ƒç´ 
    const nameInput = document.getElementById("nameInput");
    const qtyInput = document.getElementById("qtyInput");
    const addBtn = document.getElementById("addBtn");
    const reportBody = document.getElementById("reportBody");
    const totalPriceCellDup = document.getElementById("totalPriceCellDup");
    const totalPvCellDup = document.getElementById("totalPvCellDup");
    const pvDiff = document.getElementById("pvDiff");
    const pvDiff2 = document.getElementById("pvDiff2");
    const pvMessage1 = document.getElementById("pvMessage1");
    const pvMessage2 = document.getElementById("pvMessage2");

    const exportBtn = document.getElementById("exportBtn");
    const previewImage = document.getElementById("previewImage");
    const shareToLineBtn = document.getElementById("shareToLineBtn");
    const nativeShareBtn = document.getElementById("nativeShareBtn");
    const clearImageBtn = document.getElementById("clearImageBtn");
    const resetReportBtn = document.getElementById("resetReportBtn");
    const buyerInput = document.getElementById("buyerInput");
    const calculatorDisplay = document.getElementById("calculatorDisplay");
    const resetCalculatorBtn = document.getElementById("resetCalculatorBtn");
    const toast = document.getElementById("toast");
    const authLoading = document.getElementById("authLoading");
    const authStatusBar = document.getElementById("authStatusBar");
    const captureArea = document.getElementById("captureArea");
    const inputArea = document.getElementById("inputArea");
    const buttonGroup = document.querySelector(".button-group");
    const errorMessage = document.getElementById("error-message");
    const errorContent = document.getElementById("error-content");
    const authLoadingTitle = authLoading.querySelector("h3");
    const authLoadingDesc = authLoading.querySelector("p");

    // åˆå§‹åŒ–æ•¸é‡é¸æ“‡ä¸‹æ‹‰æ¡†
    for (let i = 1; i <= 99; i++) {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = i;
      qtyInput.appendChild(option);
    }

    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘åŠ å¼·æ–°å…¥æœƒè‰æœ¬æé†’åŠŸèƒ½ - é›™é‡ç›£è½ç¢ºä¿è§¸ç™¼
    nameInput.addEventListener('change', function() {
      checkHerbalNewMember(this.value);
      adjustQtySelectOptions(this.value);
    });

    nameInput.addEventListener('input', function() {
      checkHerbalNewMember(this.value);
      adjustQtySelectOptions(this.value);
    });

    // å–®ç¨æå–æé†’åˆ¤æ–·å‡½æ•¸ï¼Œç¢ºä¿é‚è¼¯ä¸€è‡´
    function checkHerbalNewMember(selectedValue) {
      const trimmedValue = selectedValue.trim();
      const isHerbal = trimmedValue.includes('è‰æœ¬');
      const isNewMember = trimmedValue.includes('æ–°å…¥æœƒ');
      
      if (isHerbal && isNewMember) {
        setTimeout(() => {
          alert('ğŸ“‹ æ–°å…¥æœƒè‰æœ¬çµ„åˆæé†’ï¼š\n\nç”·ç”Ÿæ¬¾ï¼š211x2 + 101x2\nå¥³ç”Ÿæ¬¾ï¼š211x2 + 707x2\n\nè«‹åˆ†åˆ¥æ–°å¢å°æ‡‰å“é …èˆ‡æ•¸é‡');
        }, 100);
      }
    }

    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘æ ¹æ“šé¸æ“‡çš„å“é …èª¿æ•´æ•¸é‡ä¸‹æ‹‰æ¡†çš„å¯é¸ç¯„åœ
    function adjustQtySelectOptions(selectedValue) {
      const trimmedValue = selectedValue.trim();
      let maxQty = 99;
      
      if (trimmedValue.includes('æ–°å…¥æœƒ') || trimmedValue.includes('æ–°æœƒå“¡') || trimmedValue.includes('å…¥æœƒ')) {
        maxQty = 1;
      } else if (trimmedValue.includes('2711AB') && trimmedValue.includes('(4)')) {
        maxQty = 2;
      } else if (trimmedValue.includes('777ï¼±') || trimmedValue.includes('(4)')) {
        maxQty = 2;
      }
      
      qtyInput.innerHTML = '';
      for (let i = 1; i <= maxQty; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        qtyInput.appendChild(option);
      }
    }

    // å¾æœ¬åœ°å­˜å„²åŠ è¼‰é¸ä¸­çš„ç”¢å“
    function loadSelectedProducts() {
      const saved = localStorage.getItem('selectedProducts');
      if (saved) {
        selectedProducts = JSON.parse(saved);
        renderTable();
      }
    }

    // ä¿å­˜é¸ä¸­çš„ç”¢å“åˆ°æœ¬åœ°å­˜å„²
    function saveSelectedProducts() {
      localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
    }

    // ä¿å­˜ç”¨æˆ¶ä½¿ç”¨è¨˜éŒ„
    function saveUserUsageRecord() {
      localStorage.setItem('userUsageRecord', JSON.stringify(userUsageRecord));
    }

    // è¨­ç½®è©¦ç®—è€…åç¨±
    function setupLineName() {
      lineName = localStorage.getItem('lineName') || userInfo?.displayName || '';
      
      if (!lineName || lineName === 'æœªçŸ¥ç”¨æˆ¶å') {
        const input = prompt('è«‹è¼¸å…¥æ‚¨çš„ã€è©¦ç®—è€…åç¨±ã€\nï¼ˆåƒ…éœ€è¼¸å…¥ä¸€æ¬¡ï¼Œå¯éš¨æ™‚é‡ç½®ï¼‰ï¼š');
        if (input && input.trim()) {
          lineName = input.trim();
          localStorage.setItem('lineName', lineName);
        } else {
          lineName = 'æœªè¨­å®š';
        }
      }
      
      calculatorDisplay.value = lineName;
    }

    // é‡ç½®è©¦ç®—è€…åç¨±
    function resetLineName() {
      if (confirm('ç¢ºå®šè¦é‡ç½®è©¦ç®—è€…åç¨±å—ï¼Ÿ')) {
        localStorage.removeItem('lineName');
        setupLineName();
        showToast('è©¦ç®—è€…åç¨±å·²é‡ç½®');
      }
    }

    // é‡ç½®å ±è¡¨ï¼ˆæ¸…é™¤æ‰€æœ‰å“é …æ•¸æ“šï¼‰
    function resetReport() {
      if (!authStatus) return;
      
      // ç‰¹æ¬Šç”¨æˆ¶ï¼ˆè¶…ç®¡/å°Šçˆµï¼‰èˆ‡æ™®é€šç”¨æˆ¶é‡ç½®å‡ä¸æ¶ˆè€—æ¬¡æ•¸
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å“é …è¨˜éŒ„å—ï¼Ÿ')) {
        selectedProducts = [];
        saveSelectedProducts();
        renderTable();
        // é‡ç½®æ•¸é‡ä¸‹æ‹‰æ¡†ç‚ºé è¨­ç‹€æ…‹ï¼ˆ1-99ï¼‰
        qtyInput.innerHTML = '';
        for (let i = 1; i <= 99; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          qtyInput.appendChild(option);
        }
        showToast('å ±è¡¨å·²é‡ç½®');
      }
    }

    // åŠ è¼‰ç”¢å“æ•¸æ“š
    async function loadProducts() {
      try {
        const res = await fetch(`${API_URL}?action=all`);
        const data = await res.json();
        allProducts = data;
        nameInput.innerHTML = "";
        data.forEach(item => {
          const opt = document.createElement("option");
          opt.value = item.name;
          opt.textContent = item.name;
          nameInput.appendChild(opt);
        });
        setTimeout(() => {
          checkHerbalNewMember(nameInput.value);
          adjustQtySelectOptions(nameInput.value);
        }, 300);
      } catch (error) {
        showToast(`è®€å–å•†å“å¤±æ•—: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
      }
    }

    // ã€æ ¸å¿ƒä¿®æ­£3ã€‘æ¸²æŸ“è¡¨æ ¼æ™‚æª¢æŸ¥æ•¸é‡é™åˆ¶ï¼ˆé˜²æ­¢æ‰‹å‹•ä¿®æ”¹DOMè·³éé™åˆ¶ï¼‰
    function renderTable() {
      reportBody.innerHTML = "";
      let totalPrice = 0;
      let totalPv = 0;

      selectedProducts.forEach((item, idx) => {
        const trimmedName = item.name.trim();
        let maxQty = 99;
        
        if (trimmedName.includes('æ–°å…¥æœƒ') || trimmedName.includes('æ–°æœƒå“¡') || trimmedName.includes('å…¥æœƒ')) {
          maxQty = 1;
          if (item.qty > maxQty) {
            item.qty = maxQty;
            saveSelectedProducts();
          }
        } else if (trimmedName.includes('2711AB') && trimmedName.includes('(4)')) {
          maxQty = 2;
          if (item.qty > maxQty) {
            item.qty = maxQty;
            saveSelectedProducts();
          }
        }

        const subtotalPrice = item.price * item.qty;
        const subtotalPv = item.pv * item.qty;
        totalPrice += subtotalPrice;
        totalPv += subtotalPv;

        const tr = document.createElement("tr");
        const qtyOptions = Array.from({ length: maxQty }, (_, i) => {
          const val = i + 1;
          return `<option value="${val}" ${val === item.qty ? "selected" : ""}>${val}</option>`;
        }).join("");

        tr.innerHTML = `
          <td style="text-align:center;">${item.name}</td>
          <td>
            <select class="qtySelect" data-index="${idx}" style="text-align:center;">
              ${qtyOptions}
            </select>
          </td>
          <td style="text-align:center;">${item.price}</td>
          <td style="text-align:center;">${item.pv}</td>
          <td style="text-align:center;">${subtotalPrice}</td>
          <td style="text-align:center;">${subtotalPv}</td>
          <td><button class="deleteBtn" data-index="${idx}">åˆªé™¤</button></td>
        `;
        reportBody.appendChild(tr);
      });

      totalPriceCellDup.textContent = totalPrice;
      totalPvCellDup.textContent = totalPv;
      const diff1 = TARGET_PV112 - totalPv;
      const diff2 = TARGET_PV220 - totalPv;

      pvDiff.textContent = diff1 > 0 ? diff1 : 0;
      pvDiff2.textContent = diff2 > 0 ? diff2 : 0;
      pvMessage1.innerHTML = totalPv >= TARGET_PV112 ? '<span class="done">ğŸ‰ å·²é”æ¨™</span>' : '';
      pvMessage2.innerHTML = totalPv >= TARGET_PV220 ? '<span class="done">ğŸ‰ å·²é”æ¨™</span>' : '';

      // åˆªé™¤æŒ‰éˆ•äº‹ä»¶
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = e => {
          const idx = parseInt(e.target.dataset.index);
          selectedProducts.splice(idx, 1);
          saveSelectedProducts();
          renderTable();
        };
      });

      // æ•¸é‡ä¸‹æ‹‰è®Šæ›´äº‹ä»¶ï¼ˆä¿æŒé™åˆ¶æª¢æŸ¥ï¼‰
      document.querySelectorAll(".qtySelect").forEach(select => {
        select.onchange = e => {
          const idx = parseInt(e.target.dataset.index);
          const newQty = parseInt(e.target.value);
          selectedProducts[idx].qty = newQty;
          saveSelectedProducts();
          renderTable();
        };
      });
    }

    // ã€æ ¸å¿ƒä¿®æ­£4ã€‘æ·»åŠ ç”¢å“æ™‚å†æ¬¡æª¢æŸ¥æ•¸é‡é™åˆ¶ï¼ˆé›™é‡ä¿éšœï¼‰
    function addProduct() {
      if (!authStatus) {
        showToast('è«‹å…ˆå®Œæˆç”¨æˆ¶æ¬Šé™é©—è­‰', 'error');
        return;
      }

      // æ™®é€šç”¨æˆ¶æ¬¡æ•¸ç”¨å®Œæ™‚ç¦ç”¨æ–°å¢
      const isPrivilegeUser = authStatus.isVip || authStatus.isSuperAdmin;
      if (!isPrivilegeUser && authStatus.remainingTimes <= 0) {
        showToast('æ™®é€šç”¨æˆ¶ä½¿ç”¨æ¬¡æ•¸å·²é”ä¸Šé™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡å‡ç´š', 'error');
        return;
      }

      const selectedName = nameInput.value;
      const qty = parseInt(qtyInput.value);
      if (!selectedName || qty <= 0) {
        alert("è«‹é¸æ“‡å“é …èˆ‡æ•¸é‡");
        return;
      }

      const trimmedName = selectedName.trim();
      let maxQty = 99;
      
      if (trimmedName.includes('æ–°å…¥æœƒ') || trimmedName.includes('æ–°æœƒå“¡') || trimmedName.includes('å…¥æœƒ')) {
        maxQty = 1;
        if (qty > maxQty) {
          alert(`âš ï¸ æ–°å…¥æœƒç›¸é—œå“é …é™è³¼${maxQty}å€‹ï¼Œå·²è‡ªå‹•èª¿æ•´æ•¸é‡ç‚º${maxQty}`);
          qty = maxQty;
        }
      } else if (trimmedName.includes('2711AB') && trimmedName.includes('(4)')) {
        maxQty = 2;
        if (qty > maxQty) {
          alert(`âš ï¸ 2711AB(4)é™è³¼${maxQty}çµ„ï¼Œå·²è‡ªå‹•èª¿æ•´æ•¸é‡ç‚º${maxQty}`);
          qty = maxQty;
        }
      }

      const product = allProducts.find(p => p.name === selectedName);
      if (!product) {
        alert("æ‰¾ä¸åˆ°è©²å“é …");
        return;
      }

      const exists = selectedProducts.find(p => p.name === selectedName);
      if (exists) {
        const totalQty = exists.qty + qty;
        if (totalQty > maxQty) {
          alert(`âš ï¸ è©²å“é …é™è³¼${maxQty}å€‹/çµ„ï¼Œç›®å‰å·²é¸${exists.qty}å€‹/çµ„ï¼Œç„¡æ³•å†æ–°å¢`);
          return;
        }
        exists.qty += qty;
      } else {
        selectedProducts.push({ ...product, qty });
      }

      saveSelectedProducts();
      renderTable();
    }

    // æª¢æŸ¥ç”¨æˆ¶å‰©é¤˜ä½¿ç”¨æ¬¡æ•¸
    function checkUserRemainingTimes() {
      if (!authStatus) return false;
      
      // ç‰¹æ¬Šç”¨æˆ¶ï¼ˆè¶…ç®¡/å°Šçˆµï¼‰ä¸å—é™åˆ¶
      const isPrivilegeUser = authStatus.isVip || authStatus.isSuperAdmin;
      if (isPrivilegeUser) return true;
      
      // æ™®é€šç”¨æˆ¶æª¢æŸ¥å‰©é¤˜æ¬¡æ•¸
      const userId = userInfo.userId;
      const usedTimes = userUsageRecord[userId] || 0;
      authStatus.remainingTimes = 3 - usedTimes;
      
      // æ›´æ–°æ¬Šé™ç‹€æ…‹æ¬„
      updateAuthStatusBar();
      
      // ç¦ç”¨ç›¸é—œæŒ‰éˆ•
      if (authStatus.remainingTimes <= 0) {
        exportBtn.disabled = true;
        addBtn.disabled = true;
        shareToLineBtn.disabled = true;
        return false;
      } else {
        exportBtn.disabled = false;
        addBtn.disabled = false;
        shareToLineBtn.disabled = false;
        return true;
      }
    }

    // è¨˜éŒ„ç”¨æˆ¶ä½¿ç”¨æ¬¡æ•¸ï¼ˆåŒ¯å‡ºå ±è¡¨æ™‚è¨ˆæ•¸ï¼‰
    function recordUserUsage() {
      if (!authStatus) return;
      
      // ç‰¹æ¬Šç”¨æˆ¶ä¸å—é™åˆ¶
      const isPrivilegeUser = authStatus.isVip || authStatus.isSuperAdmin;
      if (isPrivilegeUser) return;
      
      const userId = userInfo.userId;
      userUsageRecord[userId] = (userUsageRecord[userId] || 0) + 1;
      saveUserUsageRecord();
      checkUserRemainingTimes();
      showToast(`å·²ä½¿ç”¨${userUsageRecord[userId]}/3æ¬¡ï¼Œå‰©é¤˜${authStatus.remainingTimes}æ¬¡`, 'warning');
    }

    // æ›´æ–°æ¬Šé™ç‹€æ…‹æ¬„ï¼ˆèˆ‡å¾Œç«¯èº«ä»½å°é½Šï¼‰
    function updateAuthStatusBar() {
      if (!authStatus || !userInfo) return;
      
      let statusHtml = '';
      if (authStatus.isSuperAdmin) {
        // è¶…ç´šç®¡ç†å“¡é¡¯ç¤º
        const expiryText = authStatus.remainingDays === "æ°¸ä¹…æœ‰æ•ˆ" 
          ? "æ°¸ä¹…æœ‰æ•ˆ" 
          : `${authStatus.displayExpiryDate}ï¼ˆå‰©é¤˜${authStatus.remainingDays}ï¼‰`;
        statusHtml = `
          <span class="super-admin">ğŸ‘‘ è¶…ç´šç®¡ç†å“¡</span> | 
          ç”¨æˆ¶åï¼š${userInfo.displayName} | 
          æœ‰æ•ˆæœŸï¼š<span class="super-admin">${expiryText}</span>
        `;
      } else if (authStatus.isVip) {
        // å°Šçˆµç”¨æˆ¶é¡¯ç¤º
        const expiryText = authStatus.remainingDays === "æ°¸ä¹…æœ‰æ•ˆ" 
          ? "æ°¸ä¹…æœ‰æ•ˆ" 
          : `${authStatus.displayExpiryDate}ï¼ˆå‰©é¤˜${authStatus.remainingDays}ï¼‰`;
        statusHtml = `
          <span class="vip-admin">ğŸ’ å°Šçˆµç”¨æˆ¶</span> | 
          ç”¨æˆ¶åï¼š${userInfo.displayName} | 
          æœ‰æ•ˆæœŸï¼š<span class="vip-admin">${expiryText}</span>
        `;
      } else {
        // æ™®é€šç”¨æˆ¶é¡¯ç¤º
        statusHtml = `
          <span class="normal">ğŸ™‹ æ™®é€šç”¨æˆ¶</span> | 
          ç”¨æˆ¶åï¼š${userInfo.displayName} | 
          å‰©é¤˜ä½¿ç”¨æ¬¡æ•¸ï¼š<span class="${authStatus.remainingTimes <= 0 ? 'expired' : 'normal'}">${authStatus.remainingTimes || 0}/3æ¬¡</span>
        `;
      }
      authStatusBar.innerHTML = statusHtml;
      authStatusBar.style.display = 'block';
    }

    // åŒ¯å‡ºåœ–ç‰‡
    exportBtn.addEventListener("click", async () => {
      if (!checkUserRemainingTimes()) return;
      
      if (selectedProducts.length === 0) {
        alert("è«‹å…ˆæ–°å¢è‡³å°‘ä¸€å€‹å“é …ï¼Œæ‰èƒ½åŒ¯å‡ºåœ–ç‰‡ï¼");
        return;
      }

      exportBtn.disabled = true;
      exportBtn.textContent = "åŒ¯å‡ºä¸­...";

      const opCells = document.querySelectorAll("#reportTable td:last-child, #reportTable th:last-child");
      opCells.forEach(el => el.style.display = "none");

      try {
        const canvas = await html2canvas(document.getElementById("captureArea"), {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: null,
          logging: false,
          letterRendering: true,
          useTransform: true
        });
        const dataUrl = canvas.toDataURL("image/png");
        previewImage.src = dataUrl;
        previewImage.style.display = "block";
        shareToLineBtn.style.display = "inline-block";
        nativeShareBtn.style.display = navigator.share ? "inline-block" : "none";
        clearImageBtn.style.display = "inline-block";
        
        // è¨˜éŒ„ä½¿ç”¨æ¬¡æ•¸
        recordUserUsage();
      } catch (error) {
        showToast(`åŒ¯å‡ºå¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
      } finally {
        opCells.forEach(el => el.style.display = "");
        exportBtn.disabled = false;
        exportBtn.textContent = "ğŸ“¤ å ±è¡¨è½‰åœ–ç‰‡";
      }
    });

    // ä¸Šå‚³åˆ†äº«
    shareToLineBtn.addEventListener("click", async () => {
      if (!authStatus) return;
      
      if (!previewImage.src) {
        alert("è«‹å…ˆåŒ¯å‡ºåœ–ç‰‡");
        return;
      }

      shareToLineBtn.disabled = true;
      shareToLineBtn.textContent = "ä¸Šå‚³ä¸­...";

      try {
        const base64Data = previewImage.src.split(",")[1];
        const formData = new FormData();
        formData.append("image", base64Data);
        formData.append("key", IMGBB_API_KEY);

        const res = await fetch("https://api.imgbb.com/1/upload", {
          method: "POST",
          body: formData,
        });
        const result = await res.json();
        if (result.success) {
          const imageUrl = result.data.url;
          const buyerName = buyerInput.value.trim() || "æœªå¡«";
          const calculatorName = lineName || "æœªè¨­å®š";
          const lineShareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(
            `åº·åœ’è©¦ç®—å ±è¡¨\n\nè³¼è²·è€…ï¼š${buyerName}\nè©¦ç®—è€…ï¼š${calculatorName}\n${imageUrl}`
          )}`;

          window.open(lineShareUrl, "_blank");
          showToast("âœ… åœ–ç‰‡å·²ä¸Šå‚³å‚™ä»½");
        } else {
          showToast("åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", 'error');
        }
      } catch (error) {
        showToast(`åœ–ç‰‡ä¸Šå‚³éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
      } finally {
        shareToLineBtn.disabled = false;
        shareToLineBtn.textContent = "ğŸ“© ä¸Šå‚³å‚™ä»½";
      }
    });

    // åŸç”Ÿåˆ†äº«
    nativeShareBtn.addEventListener("click", async () => {
      if (!authStatus) return;
      
      if (!navigator.share || !previewImage.src) {
        alert("ç„¡æ³•ä½¿ç”¨åŸç”Ÿåˆ†äº«");
        return;
      }

      try {
        const response = await fetch(previewImage.src);
        const blob = await response.blob();
        const filesArray = [new File([blob], "åº·åœ’è©¦ç®—å ±è¡¨.png", { type: blob.type })];

        const buyer = buyerInput.value.trim() || "æœªå¡«";
        const calculator = lineName || "æœªè¨­å®š";
        const shareText = `åº·åœ’è©¦ç®—å ±è¡¨\nè³¼è²·è€…ï¼š${buyer}\nè©¦ç®—è€…ï¼š${calculator}`;

        await navigator.share({
          files: filesArray,
          title: "åº·åœ’è©¦ç®—å ±è¡¨",
          text: shareText,
        });
      } catch (error) {
        showToast(`åˆ†äº«å¤±æ•—: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
      }
    });

    // æ¸…é™¤åœ–ç‰‡
    clearImageBtn.addEventListener("click", () => {
      previewImage.style.display = "none";
      previewImage.src = "";
      shareToLineBtn.style.display = "none";
      nativeShareBtn.style.display = "none";
      clearImageBtn.style.display = "none";
    });

    // é¡¯ç¤ºæç¤º
    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type);
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // ==================== è‡ªæª¢è¡¨å°é½Šçš„æ ¸å¿ƒé©—è­‰å‡½æ•¸ ====================
    // è¨ˆç®—å‰©é¤˜å¤©æ•¸ï¼ˆå«éæœŸåˆ¤æ–·ï¼‰
    const calculateRemainingDaysByDate = (expiryDateStr) => {
      try {
        if (expiryDateStr === PERMANENT_EXPIRY_DATE) return {
          displayDate: "æ°¸ä¹…æœ‰æ•ˆ",
          remainingDays: "æ°¸ä¹…æœ‰æ•ˆ",
          isExpired: false
        };
        // å…¼å®¹æ©«æ§“/æ–œæ§“ã€è£œé›¶/éè£œé›¶æ—¥æœŸ
        const dateReg = /^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/;
        if (!dateReg.test(expiryDateStr)) return {
          displayDate: "æ ¼å¼éŒ¯èª¤",
          remainingDays: "æ ¼å¼éŒ¯èª¤",
          isExpired: true
        };

        // çµ±ä¸€æ‹†åˆ†æ—¥æœŸéƒ¨åˆ†
        const dateParts = expiryDateStr.replace(/-/g, '/').split('/').map(Number);
        const [year, month, day] = dateParts;

        // æ§‹é€ åˆ°æœŸæ—¥æœ€å¾Œä¸€ç§’ï¼ˆç•¶å¤©å…¨å¤©æœ‰æ•ˆï¼‰
        const expiryDate = new Date(year, month - 1, day, 23, 59, 59, 999);
        const now = new Date();

        if (isNaN(expiryDate.getTime())) return {
          displayDate: "æ—¥æœŸç„¡æ•ˆ",
          remainingDays: "æ—¥æœŸç„¡æ•ˆ",
          isExpired: true
        };

        // è¨ˆç®—å¤©æ•¸å·®
        const oneDayMs = 1000 * 3600 * 24;
        const timeDiff = expiryDate.getTime() - now.getTime();
        let dayDiff = Math.ceil(timeDiff / oneDayMs);

        // æ ¼å¼åŒ–é¡¯ç¤ºæ—¥æœŸ
        const fmtMonth = String(month).padStart(2, '0');
        const fmtDay = String(day).padStart(2, '0');
        const displayDate = `${year}/${fmtMonth}/${fmtDay}`;

        // åˆ¤æ–·ç‹€æ…‹
        let remainingDaysText;
        let isExpired = false;
        if (timeDiff < 0) {
          remainingDaysText = "<span class='expired'>å·²éæœŸ</span>";
          isExpired = true;
        } else if (dayDiff === 0) {
          remainingDaysText = "<span class='warning'>æœ€å¾Œ1å¤©</span>";
          isExpired = false;
        } else if (dayDiff <= 30) {
          remainingDaysText = `<span class='warning'>${dayDiff} å¤©</span>`;
          isExpired = false;
        } else {
          remainingDaysText = `${dayDiff} å¤©`;
          isExpired = false;
        }

        return { displayDate, remainingDays: remainingDaysText, isExpired };
      } catch (e) {
        console.error("è¨ˆç®—å‰©é¤˜å¤©æ•¸å¤±æ•—ï¼š", e, expiryDateStr);
        return {
          displayDate: "è¨ˆç®—éŒ¯èª¤",
          remainingDays: "è¨ˆç®—éŒ¯èª¤",
          isExpired: true
        };
      }
    };

    // é¡¯ç¤ºéŒ¯èª¤ï¼ˆå°é½Šè‡ªæª¢è¡¨ï¼Œé«˜è³ªæ„Ÿæ¨£å¼ï¼‰
    const showError = (msg) => {
      authLoading.style.display = 'none';
      captureArea.style.display = 'none';
      inputArea.style.display = 'none';
      buttonGroup.style.display = 'none';
      errorContent.innerHTML = `<p class="font-medium">${msg}</p>
        <div class="mt-3 flex justify-center">
          <button onclick="window.location.reload()" class="text-white hover:text-[#fff]">
            é‡æ–°å˜—è©¦
          </button>
        </div>`;
      errorMessage.style.display = 'block';
    };

    // é©—è­‰ç”¨æˆ¶ï¼ˆJSONPè«‹æ±‚ï¼Œä¿®å¾©VIPåˆ¤æ–·å•é¡Œï¼‰
    const verifyUserFromBackend = (profile) => {
      return new Promise((resolve, reject) => {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘å„ªå…ˆä½¿ç”¨profile.userIdï¼ˆèˆ‡å¾Œç«¯æ¸…æ´—è¦å‰‡å°é½Šï¼‰
        const decodedToken = liff.getDecodedIDToken();
        const userId = profile.userId || decodedToken?.sub || "";
        const displayName = profile.displayName || 'LINEç”¨æˆ¶';
        console.log("å‚³éçµ¦å¾Œç«¯çš„ç”¨æˆ¶IDï¼š", userId); // èª¿è©¦æ—¥å¿—
        
        const data = {
          action: 'verifyUser',
          userId: userId,
          displayName: displayName,
          callback: 'verifyCallback',
          dataType: 'userVerify'
        };

        $.ajax({
          url: API_URL,
          dataType: 'jsonp',
          jsonp: 'callback',
          jsonpCallback: 'verifyCallback',
          timeout: JSONP_TIMEOUT,
          data: data,
          success: function (resp) {
            console.log("å¾Œç«¯è¿”å›çš„é©—è­‰æ•¸æ“šï¼š", resp); // èª¿è©¦æ—¥å¿—
            if (resp.status === "success") {
              // ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥ä½¿ç”¨å¾Œç«¯è¿”å›çš„isVipå’ŒisSuperAdminï¼Œä¸åšé¡å¤–éæ¿¾
              const expiryData = calculateRemainingDaysByDate(resp.expiryDate || PERMANENT_EXPIRY_DATE);
              resolve({
                ...resp,
                displayName: displayName,
                remainingDays: expiryData.remainingDays,
                displayExpiryDate: expiryData.displayDate,
                isExpired: expiryData.isExpired,
                // å¼·åˆ¶ä¿ç•™å¾Œç«¯è¿”å›çš„VIPç‹€æ…‹
                isVip: resp.isVip === true,
                isSuperAdmin: resp.isSuperAdmin === true
              });
            } else {
              showError(resp.message || "ç”¨æˆ¶é©—è­‰å¤±æ•—");
              resolve(null);
            }
          },
          error: function (xhr, status, error) {
            console.error("ç”¨æˆ¶é©—è­‰è«‹æ±‚å¤±æ•—ï¼š", status, error);
            const errorMsg = status === 'timeout' 
              ? 'é©—è­‰è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡æ–°å˜—è©¦' 
              : `é©—è­‰å¤±æ•—ï¼š${error || 'æœªçŸ¥ç¶²çµ¡éŒ¯èª¤'}`;
            showError(errorMsg);
            reject(new Error(errorMsg));
          }
        });
      });
    };

    // JSONPå›èª¿å‡½æ•¸
    window.verifyCallback = function (resp) {
      console.log("ç”¨æˆ¶æˆæ¬Šé©—è­‰è¿”å›ï¼š", resp);
    };

    // ==================== åˆå§‹åŒ–LIFFèˆ‡é©—è­‰ï¼ˆå„ªåŒ–æç¤ºæ–‡æœ¬ï¼‰ ====================
    async function initLiffAndAuth() {
      try {
        // åˆå§‹åŒ–LIFFï¼šæ·»åŠ withLoginOnExternalBrowserå¢å¼·å…¼å®¹æ€§
        updateAuthLoadingText("æ­£åœ¨åˆå§‹åŒ–LINEç™»éŒ„", "è«‹ç¨å€™...");
        await liff.init({ 
          liffId: LIFF_ID,
          withLoginOnExternalBrowser: true
        });

        // æœªç™»éŒ„å‰‡å¼•å°ç™»éŒ„
        if (!liff.isLoggedIn()) {
          updateAuthLoadingText("è«‹å…ˆç™»éŒ„LINEè³¬è™Ÿ", "å°‡è‡ªå‹•è·³è½‰è‡³ç™»éŒ„é é¢...");
          liff.login({ redirectUri: window.location.href });
          return;
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const profile = await liff.getProfile();
        userInfo = {
          userId: profile.userId,
          displayName: profile.displayName
        };
        console.log("ç²å–çš„LINEç”¨æˆ¶ä¿¡æ¯ï¼š", userInfo);

        // èª¿ç”¨å¾Œç«¯é©—è­‰ç”¨æˆ¶ï¼ˆå°é½Šè‡ªæª¢è¡¨JSONPæ–¹å¼ï¼‰
        updateAuthLoadingText("æ­£åœ¨é©—è­‰æˆæ¬Šç‹€æ…‹", "æ ¸å°ç”¨æˆ¶æ¬Šé™ä¸­...");
        const authData = await verifyUserFromBackend(profile);

        if (!authData) {
          return;
        }

        // éæœŸåˆ¤æ–·æ””æˆª
        if (authData.isExpired) {
          showError('æ‚¨çš„è³¬è™Ÿå·²éæœŸï¼Œç„¡æ³•ç™»éŒ„è©¦ç®—ç³»çµ±ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡çºŒæœŸ');
          return;
        }

        // ã€æ ¸å¿ƒä¿®æ­£ã€‘å®Œæ•´å­˜å„²å¾Œç«¯è¿”å›çš„æ¬Šé™ç‹€æ…‹
        authStatus = {
          isVip: authData.isVip,
          isSuperAdmin: authData.isSuperAdmin,
          remainingDays: authData.remainingDays,
          displayExpiryDate: authData.displayExpiryDate,
          expiryDate: authData.expiryDate,
          usageCount: authData.usageCount || 0,
          isExpired: authData.isExpired,
          remainingTimes: 0
        };
        console.log("æœ€çµ‚ç”¨æˆ¶æ¬Šé™ç‹€æ…‹ï¼š", authStatus);

        // éš±è—åŠ è¼‰æç¤ºï¼Œé¡¯ç¤ºåŠŸèƒ½å€åŸŸ
        authLoading.style.display = 'none';
        captureArea.style.display = 'block';
        inputArea.style.display = 'flex';
        buttonGroup.style.display = 'flex';

        // åˆå§‹åŒ–é é¢
        setupLineName();
        loadProducts();
        loadSelectedProducts();
        checkUserRemainingTimes();
        updateAuthStatusBar();

        showToast(`æ­¡è¿å›ä¾†ï¼Œ${userInfo.displayName}ï¼`);
      } catch (error) {
        const errorMsg = error.message || 'æœªçŸ¥åˆå§‹åŒ–éŒ¯èª¤';
        updateAuthLoadingText("åˆå§‹åŒ–å¤±æ•—", errorMsg + "<br/>è«‹åˆ·æ–°é é¢é‡è©¦");
        showToast(`åˆå§‹åŒ–å¤±æ•—ï¼š${errorMsg}`, 'error');
        console.error('åˆå§‹åŒ–éŒ¯èª¤ï¼š', error);
      }
    }

    // æ›´æ–°é©—è­‰åŠ è¼‰æ–‡æœ¬
    function updateAuthLoadingText(title, desc) {
      if (authLoadingTitle) authLoadingTitle.textContent = title;
      if (authLoadingDesc) authLoadingDesc.innerHTML = desc;
    }

    // äº‹ä»¶ç›£è½
    addBtn.addEventListener("click", addProduct);
    resetCalculatorBtn.addEventListener("click", resetLineName);
    resetReportBtn.addEventListener("click", resetReport);

    // çª—å£å¤§å°è®ŠåŒ–è™•ç†
    window.addEventListener('resize', () => {
      adjustTableDisplay();
    });

    // èª¿æ•´è¡¨æ ¼é¡¯ç¤º
    function adjustTableDisplay() {
      const table = document.getElementById('reportTable');
      const width = window.innerWidth;
      
      if (width < 360) {
        table.style.fontSize = '11px';
      } else {
        table.style.fontSize = '12px';
      }
    }

    // åŠ è¼‰jQueryå¾Œåˆå§‹åŒ–ï¼ˆå¢å¼·ç­‰å¾…é‚è¼¯ï¼‰
    function initApp() {
      if (window.jQuery) {
        initLiffAndAuth();
      } else {
        // æœ€å¤šç­‰å¾…5ç§’ï¼Œé¿å…ç„¡é™è¼ªè©¢
        let waitCount = 0;
        const interval = setInterval(() => {
          waitCount++;
          if (window.jQuery || waitCount >= 50) {
            clearInterval(interval);
            if (window.jQuery) {
              initLiffAndAuth();
            } else {
              updateAuthLoadingText("jQueryåŠ è¼‰å¤±æ•—", "è«‹æª¢æŸ¥ç¶²çµ¡æˆ–åˆ·æ–°é é¢");
              showToast('jQueryåŠ è¼‰å¤±æ•—', 'error');
            }
          }
        }, 100);
      }
    }

    // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
    window.onload = initApp;
  </script>
</body>
</html>

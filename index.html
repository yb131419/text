<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1e1e1e" />
  <title>LINE ç™»å…¥ç¯„ä¾‹</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      padding: 24px;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #1a1a1a, #222222);
      color: #e0e0e0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      flex-direction: column;
      gap: 12px;
    }
    main.card {
      background: rgba(30, 30, 30, 0.9);
      border-radius: 20px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.9);
      max-width: 400px;
      width: 100%;
      padding: 28px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #userInfo {
      width: 100%;
      padding: 18px 24px;
      background: linear-gradient(135deg, #0f1c3f, #2a5298);
      border-radius: 20px;
      color: #e0f7ff;
      text-align: center;
      margin-bottom: 24px;
    }
    #userInfo .name { font-size: 22px; font-weight: 800; margin-bottom: 6px; }
    #userInfo .daysWrapper { display: inline-block; padding: 8px 20px; border-radius: 20px; background: #444; margin-top: 8px; }
    #userInfo .daysWrapper.danger { background: #ff6f61; color: #fff; }
    .status { font-size: 14px; margin-top: 12px; color: #b0b0b0; }
    .error { color: #ff6b6b; font-weight: 700; margin-top: 12px; }
    .success { color: #4cd964; font-weight: 700; margin-top: 12px; }
  </style>
</head>
<body>
  <main class="card">
    <div id="userInfo">â³ å–å¾—ä½¿ç”¨è€…è³‡è¨Šä¸­...</div>
  </main>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // é…ç½®åƒæ•¸
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxsl-llg3RMZZkLnje8Qq4eQNg6lK869zq5f44EMATyHMmnV_5K_6RnSbzUUGbOevqm/exec";
    const LIFF_ID = "2007488640-PbB48ELN";
    const SHEET_ID = "1LXeXS2NCIQKCB0aJnOmaKcs3fVow_9bDfjmyMeAm-Qo"; // ç›®æ¨™å·¥ä½œè¡¨ID
    
    let liffUserId = "", hasPermission = false;

    window.onload = async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        
        // å¦‚æœæœªç™»å…¥ï¼Œé€²è¡ŒLINEç™»å…¥
        if (!liff.isLoggedIn()) {
          return liff.login();
        }

        let profile = null, idToken = null;
        try {
          // å–å¾—ä½¿ç”¨è€…è³‡æ–™
          profile = await liff.getProfile();
          idToken = liff.getDecodedIDToken();
        } catch (e) {
          document.getElementById("userInfo").innerHTML = `<div class="error">âŒ ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥ã€‚</div>`;
          return;
        }

        // æå–ä½¿ç”¨è€…ID
        liffUserId = (idToken?.sub) || (profile?.userId) || "";
        if (!liffUserId) {
          document.getElementById("userInfo").innerHTML = `<div class="error">âŒ ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼Œè«‹ç¢ºèªå·²ç™»å…¥ LINEã€‚</div>`;
          return;
        }

        // é¡¯ç¤ºåŸºæœ¬ç”¨æˆ¶è³‡è¨Š
        const userName = profile?.displayName || "æœªçŸ¥ä½¿ç”¨è€…";
        const userInfoDiv = document.getElementById("userInfo");
        userInfoDiv.innerHTML = `
          <div class="name">ğŸ‘¤ ${userName}</div>
          <div class="status">æ­£åœ¨åŒæ­¥è³‡æ–™åˆ°å·¥ä½œè¡¨...</div>
        `;

        // å…ˆå°‡ç”¨æˆ¶è³‡è¨Šå‚³é€åˆ°æŒ‡å®šå·¥ä½œè¡¨
        await sendUserToSheet(liffUserId, userName);
        
        // å†æª¢æŸ¥æ¬Šé™
        checkPermission(liffUserId, userName);

      } catch (err) {
        document.getElementById("userInfo").innerHTML = `<div class="error">âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</div>`;
        console.error("LIFF åˆå§‹åŒ–éŒ¯èª¤", err);
      }
    };

    /**
     * å°‡ç”¨æˆ¶ä¿¡æ¯ç™¼é€åˆ°æŒ‡å®šçš„Googleå·¥ä½œè¡¨
     */
    function sendUserToSheet(userId, userName) {
      return new Promise((resolve, reject) => {
        // å‰µå»ºå”¯ä¸€çš„å›èª¿å‡½æ•¸åç¨±
        const callbackName = `sheetCallback_${Date.now()}`;
        
        // æ§‹å»ºè«‹æ±‚URLï¼ŒåŒ…å«å·¥ä½œè¡¨IDã€ç”¨æˆ¶IDå’Œç”¨æˆ¶å
        const url = `${SCRIPT_URL}?` + new URLSearchParams({
          callback: callbackName,
          action: "addUser",
          sheetId: SHEET_ID,
          userId: userId,
          userName: userName,
          timestamp: new Date().toISOString()
        });
        
        // å‰µå»ºscriptæ¨™ç±¤é€²è¡ŒJSONPè«‹æ±‚
        const script = document.createElement("script");
        script.src = url;
        script.type = "text/javascript";
        
        // è¨­ç½®è¶…æ™‚
        const timeout = setTimeout(() => {
          document.getElementById("userInfo").innerHTML += `<div class="error">âš ï¸ è³‡æ–™åŒæ­¥è¶…æ™‚</div>`;
          cleanup();
          resolve(); // å³ä½¿è¶…æ™‚ä¹Ÿç¹¼çºŒå¾ŒçºŒæµç¨‹
        }, 10000);
        
        // å›èª¿å‡½æ•¸
        window[callbackName] = function(response) {
          clearTimeout(timeout);
          const userInfoDiv = document.getElementById("userInfo");
          
          if (response?.success) {
            userInfoDiv.innerHTML += `<div class="success">âœ… è³‡æ–™å·²åŒæ­¥åˆ°å·¥ä½œè¡¨</div>`;
          } else {
            userInfoDiv.innerHTML += `<div class="error">âš ï¸ è³‡æ–™åŒæ­¥å¤±æ•—: ${response?.error || "æœªçŸ¥éŒ¯èª¤"}</div>`;
          }
          
          cleanup();
          resolve();
        };
        
        // éŒ¯èª¤è™•ç†
        script.onerror = function() {
          clearTimeout(timeout);
          document.getElementById("userInfo").innerHTML += `<div class="error">âš ï¸ åŒæ­¥è«‹æ±‚å¤±æ•—</div>`;
          cleanup();
          resolve(); // å³ä½¿éŒ¯èª¤ä¹Ÿç¹¼çºŒå¾ŒçºŒæµç¨‹
        };
        
        // æ¸…ç†å‡½æ•¸
        function cleanup() {
          document.body.removeChild(script);
          delete window[callbackName];
        }
        
        // ç™¼é€è«‹æ±‚
        document.body.appendChild(script);
      });
    }

    /**
     * æª¢æŸ¥ç”¨æˆ¶æ¬Šé™
     */
    function checkPermission(userId, displayName = "ä½¿ç”¨è€…") {
      window.handlePermission = res => {
        const infoDiv = document.getElementById("userInfo");
        if (res?.auth) {
          hasPermission = true;
          const days = calcDaysLeft(res.expiryDate);
          const danger = typeof days === "number" && days <= 3;
          
          // æ·»åŠ æ¬Šé™ä¿¡æ¯
          infoDiv.innerHTML += `
            <div class="daysWrapper ${danger ? "danger" : ""}">å‰©é¤˜æ—¥ï¼š${typeof days === "number" ? days + " å¤©" : days}</div>
            <div>åˆ°æœŸæ—¥ï¼š${formatTaipeiDate(res.expiryDate)}</div>
          `;
        } else {
          infoDiv.innerHTML += `
            <div class="daysWrapper">ç„¡æ¬Šé™</div>
            <div class="error">â›” å°šæœªé–‹é€šä½¿ç”¨æ¬Šé™</div>
          `;
        }
      };
      
      // ç™¼é€æ¬Šé™æª¢æŸ¥è«‹æ±‚
      const s = document.createElement("script");
      s.src = `${SCRIPT_URL}?userId=${userId}&checkAuth=1&callback=handlePermission`;
      s.onerror = () => document.getElementById("userInfo").innerHTML += `<div class="error">âŒ æ¬Šé™é©—è­‰å¤±æ•—</div>`;
      document.body.appendChild(s);
    }

    /**
     * è¨ˆç®—å‰©é¤˜å¤©æ•¸
     */
    function calcDaysLeft(dateStr) {
      const d = new Date(dateStr?.trim()), now = new Date();
      const diff = Math.floor((d - now) / (1000 * 60 * 60 * 24));
      return isNaN(diff) ? "ç„¡æ•ˆæ—¥æœŸ" : diff < 0 ? "å·²éæœŸ" : diff;
    }

    /**
     * æ ¼å¼åŒ–å°åŒ—æ™‚é–“çš„æ—¥æœŸ
     */
    function formatTaipeiDate(dateStr) {
      const d = new Date(dateStr?.trim());
      return isNaN(d.getTime()) ? "ç„¡æ•ˆæ—¥æœŸ" : d.toLocaleDateString('zh-TW', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        timeZone: 'Asia/Taipei' 
      });
    }
  </script>
</body>
</html>
    

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å½¥å½¬ğŸŒ¿è©¦ç®—ç³»çµ±ï¼ˆé©—è­‰ç‰ˆï¼‰</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
:root {
  --bg: #0f0f0f;--panel-bg: #1a1a1a;--text: #e0e0e0;--accent: #00d1b2;--highlight: #40c4ff;
  --error: #ff5252;--btn-grey: #3a3a3a;--warning: #ff9800;--super: #d4af37;--vip: #00bfa5;
  --grad-primary: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
  --grad-secondary: linear-gradient(145deg, #2d2d2d, #1f1f1f);
  --shadow: 0 8px 32px rgba(0,0,0,0.4);--loader: #00d1b2;
  --vip-username: linear-gradient(135deg, #00bfa5, #00ffde);
  --super-username: linear-gradient(135deg, #d4af37, #ffff00);--yellow: #ffd700;
}
* {box-sizing: border-box;margin: 0;padding: 0;}
body {
  background: var(--bg);color: var(--text);font-family: 'Segoe UI', 'Noto Sans TC', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
  padding: 10px;line-height: 1.5;min-height: 100vh;display: flex;flex-direction: column;align-items: center;
}
#authContainer {width: 100%;max-width: 400px;margin: 0 auto;display: flex;flex-direction: column;align-items: center;}
#authLoading {
  width: 100%;background: var(--grad-secondary);border-radius: 16px;padding: 40px 25px;text-align: center;
  box-shadow: var(--shadow);border: 1px solid rgba(255,255,255,0.05);transition: all 0.5s ease;
}
.loader {
  width: 50px;height: 50px;border: 3px solid rgba(255,255,255,0.1);border-top-color: var(--loader);
  border-radius: 50%;animation: spin 1s linear infinite, pulse 2s ease-in-out infinite alternate;margin: 0 auto 20px;
}
@keyframes spin {to {transform: rotate(360deg);}}
@keyframes pulse {
  from {box-shadow: 0 0 15px rgba(0,209,178,0.3);}
  to {box-shadow: 0 0 25px rgba(0,209,178,0.6);}
}
#authLoading h3 {margin: 0 0 8px 0;font-size: 1.2rem;color: var(--highlight);font-weight: 600;}
#authLoading p {margin: 0;font-size: 0.95rem;color: #bbb;line-height: 1.6;}
#authStatusBar {
  background: var(--grad-secondary);padding: 12px 18px;border-radius: 12px;margin-bottom: 20px;
  font-size: 14px;text-align: center;border: 1px solid rgba(0,209,178,0.3);box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  display: none;width: 100%;max-width: 600px;
}
.super-admin {color: var(--super);font-weight: bold;}
.vip-admin {color: var(--vip);font-weight: bold;}
.normal {color: var(--highlight);font-weight: bold;}
.expired {color: var(--error);font-weight: bold;}
.remaining-days-yellow {color: var(--yellow);font-weight: bold;text-shadow: 0 0 5px rgba(255,215,0,0.5);}
.super-admin-username, .vip-admin-username {
  background-clip: text;-webkit-background-clip: text;color: transparent;font-weight: bold;text-shadow: 0 0 8px rgba(255,255,255,0.3);
}
.super-admin-username {background-image: var(--super-username);}
.vip-admin-username {background-image: var(--vip-username);}
#captureArea {
  background: linear-gradient(145deg, #1c1c1c, #141414);box-shadow: inset 0 1px 2px rgba(255,255,255,0.05),0 4px 20px rgba(0,0,0,0.6);
  color: var(--text);padding: 15px 10px;border-radius: 12px;margin-bottom: 15px;overflow-x: auto;
  display: none;width: 100%;max-width: 600px;
}
#captureArea h2 {
  text-align: center;font-size: 2rem;font-weight: bold;color: #fff;margin: 0 0 15px 0;padding: 10px 0;
  line-height: 1.3;width: 100%;
}
@media (min-width:768px) {#captureArea h2 {font-size: 2.4rem;}}
.userInputs {display: flex;flex-direction: column;gap: 10px;margin-bottom: 15px;}
.userInputs .row {display: flex;gap: 10px;width: 100%;}
.userInputs label {flex: 1;display: flex;flex-direction: column;font-size: 14px;color: #bbb;}
.userInputs label span {text-align: center;margin-bottom: 4px;font-size: 15px;}
.userInputs input {
  padding: 10px;font-size: 16px;background: #333;color: var(--text);border: none;
  border-radius: 6px;width: 100%;text-align: center;
}
.calculator-container {display: flex;gap: 5px;}
#resetCalculatorBtn {
  padding: 10px;background: var(--btn-grey);color: #fff;border: none;border-radius: 6px;
  cursor: pointer;font-size: 14px;flex-shrink: 0;width: 40px;
}
#resetCalculatorBtn:hover {background: #555;}
#nameInput option {padding: 12px 10px;line-height: 1.6;font-size: 16px;height: auto;white-space: normal;}
/* è¡¨æ ¼æ ·å¼ç´§å‡‘åŒ–ä¼˜åŒ– - æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ† */
#reportTable {
  width: 100%;min-width: 260px; /* é™ä½æœ€å°å®½åº¦ï¼Œé€‚é…å°å±å¹• */
  border-collapse: collapse;font-size: 11px; /* æ•´ä½“ç¼©å°å­—ä½“ */
  border-radius: 10px;overflow: hidden;background: #f9fafb;color: #374151;margin: 0 auto;
}
/* è°ƒæ•´åˆ—å®½ï¼Œæ›´ç´§å‡‘åˆ†é… */
#reportTable th:nth-child(1),#reportTable td:nth-child(1) {width: 20%;} /* å“é …åç¨±ç¼©çª„ */
#reportTable th:nth-child(2),#reportTable td:nth-child(2) {width: 8%;}  /* æ•¸é‡ç¼©çª„ */
#reportTable th:nth-child(3),#reportTable td:nth-child(3) {width: 10%;} /* å–®åƒ¹ç¼©çª„ */
#reportTable th:nth-child(4),#reportTable td:nth-child(4) {width: 8%;}  /* PVç¼©çª„ */
#reportTable th:nth-child(5),#reportTable td:nth-child(5) {width: 14%;} /* å°è¨ˆé‡‘é¡ç¼©çª„ */
#reportTable th:nth-child(6),#reportTable td:nth-child(6) {width: 14%;} /* å°è¨ˆPVç¼©çª„ */
#reportTable th:nth-child(7),#reportTable td:nth-child(7) {width: 8%;}  /* æ“ä½œç¼©çª„ */
#reportTable th,#reportTable td {
  border: 1px solid #d1d5db;padding: 4px 2px; /* å‡å°‘å†…è¾¹è·ï¼Œæ›´ç´§å‡‘ */
  text-align: center;white-space: nowrap;transition: all 0.3s ease;
}
#reportTable th:nth-child(2),#reportTable td:nth-child(2),.qtySelect {font-size: 14px !important;font-weight: bold !important;}
#reportTable td:nth-child(3),#reportTable td:nth-child(4),#reportTable td:nth-child(5),#reportTable td:nth-child(6) {font-weight: 500;text-align: center !important;}
/* å¤§å±é€‚é…å¾®è°ƒï¼Œä¿æŒç´§å‡‘ */
@media (min-width:768px) {
  #reportTable th,#reportTable td {padding: 6px 3px;font-size: 12px;}
  #reportTable th:nth-child(2),#reportTable td:nth-child(2),.qtySelect,#qtyInput {font-size: 16px !important;}
}
#reportTable thead {background: linear-gradient(90deg, #2b6cb0, #3182ce);color: #fff;font-weight: 600;}
#reportTable tbody tr:nth-child(odd) {background: #f3f4f6;}
#reportTable tbody tr:nth-child(even) {background: #e5e7eb;}
#reportTable tbody tr:hover {background: #1e88e5;color: #fff;font-weight: bold;transform: scale(1.01);}
.deleteBtn {
  writing-mode: vertical-rl;text-orientation: upright;background: var(--error);border: none;
  color: #fff;border-radius: 4px;padding: 1px;cursor: pointer;font-size: 10px; /* ç¼©å°åˆ é™¤æŒ‰é’®å­—ä½“ */
  display: inline-block;margin: 0 auto;width: 18px; /* å›ºå®šæ“ä½œæŒ‰é’®å®½åº¦ */
}
/* è¡¨æ ¼æ ·å¼ä¼˜åŒ–ç»“æŸ */
.summaryBox {
  text-align: center;margin-top: 13px;font-size: 1rem;font-weight: bold;
  color: var(--highlight);line-height: 1.6;
}
.summaryBox .extra {
  display: block;font-size: 0.9rem;color: var(--accent);margin-top: 4px;
  font-weight: bold; /* ç»Ÿä¸€å­—ä½“ç²—ç»† */
}
.summaryBox .done {color: #4caf50;font-weight: bold;}
#totalPriceCellDup, #totalPvCellDup, #pvDiff, #pvDiff2 {
  display: inline-block;min-width: 60px;text-align: center;
  font-size: 0.9rem; /* ç»Ÿä¸€å­—ä½“å¤§å° */
  font-weight: bold; /* ç»Ÿä¸€å­—ä½“ç²—ç»† */
}
#inputArea {
  display: flex;flex-direction: column;gap: 10px;margin: 15px 0 30px 0;
  display: none;width: 100%;max-width: 600px;
}
@media (min-width:576px) {#inputArea {flex-direction: row;align-items: center;}}
#nameInput,#qtyInput,#addBtn {padding: 10px;font-size: 16px;border-radius: 6px;border: none;}
#qtyInput {font-size: 18px !important;font-weight: bold;}
#nameInput,#qtyInput {background: #2c2c2c;color: var(--text);flex: 1;text-align: center;}
#addBtn,#exportBtn,#shareToLineBtn,#nativeShareBtn,#clearImageBtn,#resetReportBtn {
  background: linear-gradient(145deg, #00bfa5, #009e8a);box-shadow: 0 4px 8px rgba(0,191,165,0.3);
  color: #fff;cursor: pointer;transition: all 0.3s ease;text-align: center;font-size: 15px;
}
#addBtn:hover,#exportBtn:hover,#shareToLineBtn:hover,#nativeShareBtn:hover,#resetReportBtn:hover {
  background: linear-gradient(145deg, #00ccb2, #00a98e);transform: translateY(-2px);
}
#addBtn:disabled,#exportBtn:disabled,#shareToLineBtn:disabled,#resetReportBtn:disabled {
  background: var(--btn-grey);cursor: not-allowed;transform: none;box-shadow: none;
}
#addBtn {width: 100%;}
@media (min-width:576px) {#addBtn {width: 120px;}}
.button-group {
  display: flex;flex-wrap: wrap;gap: 8px;justify-content: center;margin: 10px 0;
  display: none;width: 100%;max-width: 600px;
}
#exportBtn,#shareToLineBtn,#nativeShareBtn,#clearImageBtn,#resetReportBtn {
  flex: 1;min-width: 110px;margin: 0;padding: 10px 0;font-size: 15px;border-radius: 8px;
}
#clearImageBtn {background: var(--btn-grey);}
#clearImageBtn:hover {background: #555;}
#clearImageBtn:disabled {background: #2a2a2a;cursor: not-allowed;}
#resetReportBtn {background: #ff9800;}
#resetReportBtn:hover {background: #ffa726;}
#resetReportBtn:disabled {background: #b36a00;cursor: not-allowed;}
#previewImage {
  display: none;max-width: 100%;border: 2px solid #888;border-radius: 10px;
  margin: 15px auto;max-width: 600px;
}
#shareToLineBtn,#nativeShareBtn,#clearImageBtn {display: none;}
#buyerInput,#calculatorDisplay {
  background: #f9fafb;border: 1.5px solid #d1d5db;color: #374151;border-radius: 8px;
  padding: 10px 12px;font-size: 16px;transition: border-color 0.3s ease, box-shadow 0.3s ease;
  width: 100%;font-weight: 500;
}
@media (min-width:768px) {#buyerInput,#calculatorDisplay {font-size: 18px;}}
#buyerInput:focus {
  border-color: #2563eb;box-shadow: 0 0 8px 2px rgba(37,99,235,0.3);
  outline: none;background: #fff;
}
#calculatorDisplay {background: #e9ecef;cursor: default;}
#buyerInput::placeholder {color: #9ca3af;font-weight: 400;text-align: center;}
.toast {
  position: fixed;bottom: 30px;left: 50%;transform: translateX(-50%);
  background: var(--grad-secondary);color: #fff;padding: 12px 20px;border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);opacity: 0;transition: opacity 0.5s ease, transform 0.5s ease;
  z-index: 1000;text-align: center;min-width: 200px;font-size: 15px;border: 1px solid rgba(255,255,255,0.1);
}
.toast.show {opacity: 1;transform: translateX(-50%) translateY(-10px);}
.toast.error {background: linear-gradient(145deg, #4a0000, #2a0000);border-color: rgba(255,82,82,0.3);}
.toast.warning {background: linear-gradient(145deg, #4a3200, #2a1e00);border-color: rgba(255,152,0,0.3);}
.payment-options {
  display: flex;justify-content: center;gap: 15px;margin-top: 8px;
  color: #fff;font-size: 1.1rem;flex-wrap: wrap;
}
.payment-options label {display: flex;align-items: center;gap: 8px;color: #fff;font-weight: 500;}
.payment-options input[type="checkbox"] {width: 18px;height: 18px;}
@media print {
  body {background: #fff;color: #000;}
  #authContainer,#authLoading,#authStatusBar,#inputArea,#addBtn,#exportBtn,#shareToLineBtn,#clearImageBtn,#nativeShareBtn,#resetCalculatorBtn,#resetReportBtn {display: none !important;}
  #captureArea {box-shadow: none;background: #fff;color: #000;display: block !important;}
  #reportTable th {background: #ccc !important;color: #000 !important;}
  .deleteBtn {display: none !important;}
  .summaryBox {color: #000 !important;}
  #reportTable td, #reportTable th {text-align: center !important;}
  #reportTable th:nth-child(2),#reportTable td:nth-child(2) {font-size: 16px !important;font-weight: bold !important;}
}
.spacer {height: 80px;}
@media (max-width:360px) {
  .userInputs .row {gap: 5px;}
  .userInputs label {font-size: 13px;}
  .userInputs input {font-size: 15px;padding: 8px;}
  #reportTable {font-size: 10px;} /* è¶…å°å±è¿›ä¸€æ­¥ç¼©å°è¡¨æ ¼å­—ä½“ */
  #reportTable th:nth-child(2),#reportTable td:nth-child(2),.qtySelect,#qtyInput {font-size: 13px !important;}
  .payment-options {font-size: 1rem;}
  #authStatusBar {font-size: 12px;}
  #authLoading {padding: 30px 20px;}
  .loader {width: 40px;height: 40px;}
}
#error-message {
  display: none;background: linear-gradient(145deg, #4a0000, #2a0000);
  border: 1px solid rgba(255,82,82,0.3);color: #fef2f2;padding: 20px;border-radius: 16px;
  margin: 20px auto;max-width: 400px;text-align: center;box-shadow: var(--shadow);
}
#error-message #error-content {margin-bottom: 15px;}
#error-message button {
  background: linear-gradient(145deg, #ff5252, #d32f2f);color: #fff;border: none;
  padding: 10px 20px;border-radius: 8px;cursor: pointer;margin-top: 10px;
  font-weight: 500;transition: all 0.3s ease;
}
#error-message button:hover {
  background: linear-gradient(145deg, #ff6b6b, #e53935);transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255,82,82,0.3);
}
</style>
</head>
<body>
  <div id="authContainer">
    <div id="error-message">
      <div id="error-content"></div>
    </div>
    <div id="authLoading">
      <div class="loader"></div>
      <h3>æ­£åœ¨é©—è­‰ç”¨æˆ¶æ¬Šé™</h3>
      <p>è«‹ç¨å€™...</p>
    </div>
  </div>
  <div id="authStatusBar" style="display: none;"></div>
  <div id="captureArea">
    <h2>
      ğŸŒ¿ åº·åœ’è©¦ç®—å ±è¡¨
      <div class="payment-options">
        <label><input type="checkbox" id="cashOption" /> ç¾é‡‘</label>
        <label><input type="checkbox" id="cardOption" /> åˆ·å¡</label>
      </div>
    </h2>
    <div class="userInputs">  
      <div class="row">
        <label>
          <span>è³¼è²·è€…ï¼š</span>
          <input type="text" placeholder="è¼¸å…¥è³¼è²·è€…" id="buyerInput" />
        </label>
        <label>
          <span>è©¦ç®—è€…ï¼š</span>
          <div class="calculator-container">
            <input type="text" id="calculatorDisplay" readonly />
            <button id="resetCalculatorBtn" title="é‡ç½®è©¦ç®—è€…åç¨±">â†º</button>
          </div>
        </label>
      </div>
    </div>
    <table id="reportTable" aria-label="è©¦ç®—å ±è¡¨">
      <thead>
        <tr>
          <th>å“é …åç¨±</th>
          <th>æ•¸é‡</th>
          <th>å–®åƒ¹</th>
          <th>PV</th>
          <th>å°è¨ˆé‡‘é¡</th>
          <th>å°è¨ˆPV</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
    <div class="summaryBox" aria-live="polite">
      ç¸½ é‡‘é¡ï¼š<span id="totalPriceCellDup">0</span>ï½œç¸½ PVï¼š<span id="totalPvCellDup">0</span>
      <span class="extra">è· 11.2è¬ PVï¼š<span id="pvDiff">112000</span> <span id="pvMessage1"></span></span>
      <span class="extra">è· 22.0è¬ PVï¼š<span id="pvDiff2">220000</span> <span id="pvMessage2"></span></span>
    </div>
  </div>
  <img id="previewImage" alt="é è¦½åŒ¯å‡ºåœ–ç‰‡" />
  <div class="button-group">
    <button id="exportBtn">ğŸ“¤ å ±è¡¨è½‰åœ–ç‰‡</button>
    <button id="shareToLineBtn">ğŸ“© ä¸Šå‚³å‚™ä»½</button>
    <button id="nativeShareBtn">ğŸ“± åˆ†äº«åœ–ç‰‡</button>
    <button id="clearImageBtn">âŒ æ¸…é™¤åœ–ç‰‡</button>
    <button id="resetReportBtn">ğŸ”„ é‡ç½®å ±è¡¨</button>
  </div>
  <div id="toast" class="toast">âœ… åœ–ç‰‡å·²ä¸Šå‚³å‚™ä»½</div>
  <div id="inputArea">
    <select id="nameInput"></select>
    <select id="qtyInput"></select>
    <button id="addBtn">â• æ–°å¢å“é …</button>
  </div>
  <div class="spacer"></div>
  <script>
const API_URL = "https://script.google.com/macros/s/AKfycbyETFQSpvVF0zCq24jLNkGD_lfm6yX44JUpW4cgkTyt3pJsg4G-38_uRbRzMl5xyMPs/exec";
const IMGBB_API_KEY = "5be146133d1fa6ded66878aade98880f";
const LIFF_ID = "2007434020-Kf98vapi";
const JSONP_TIMEOUT = 10000;
const PERMANENT_EXPIRY_DATE = "9999/12/31";
const TARGET_PV112 = 112000;
const TARGET_PV220 = 220000;
const MAX_NORMAL_USER_USAGE = 10;

let products = [], selectedProds = [], lineName = '', userInfo = null, authStatus = null;
let userUsageRecord = JSON.parse(localStorage.getItem('userUsageRecord')) || {};

const nameInput = document.getElementById("nameInput");
const qtyInput = document.getElementById("qtyInput");
const addBtn = document.getElementById("addBtn");
const reportBody = document.getElementById("reportBody");
const totalPriceCellDup = document.getElementById("totalPriceCellDup");
const totalPvCellDup = document.getElementById("totalPvCellDup");
const pvDiff = document.getElementById("pvDiff");
const pvDiff2 = document.getElementById("pvDiff2");
const pvMessage1 = document.getElementById("pvMessage1");
const pvMessage2 = document.getElementById("pvMessage2");
const exportBtn = document.getElementById("exportBtn");
const previewImage = document.getElementById("previewImage");
const shareToLineBtn = document.getElementById("shareToLineBtn");
const nativeShareBtn = document.getElementById("nativeShareBtn");
const clearImageBtn = document.getElementById("clearImageBtn");
const resetReportBtn = document.getElementById("resetReportBtn");
const buyerInput = document.getElementById("buyerInput");
const calculatorDisplay = document.getElementById("calculatorDisplay");
const resetCalculatorBtn = document.getElementById("resetCalculatorBtn");
const toast = document.getElementById("toast");
const authLoading = document.getElementById("authLoading");
const authStatusBar = document.getElementById("authStatusBar");
const captureArea = document.getElementById("captureArea");
const inputArea = document.getElementById("inputArea");
const buttonGroup = document.querySelector(".button-group");
const errorMessage = document.getElementById("error-message");
const errorContent = document.getElementById("error-content");
const authLoadingTitle = authLoading.querySelector("h3");
const authLoadingDesc = authLoading.querySelector("p");

for (let i = 1; i <= 99; i++) {
  const option = document.createElement("option");
  option.value = i;
  option.textContent = i;
  qtyInput.appendChild(option);
}

nameInput.addEventListener('change', function() {
  checkHerbalNewMember(this.value);
  adjustQtySelectOptions(this.value);
});
nameInput.addEventListener('input', function() {
  checkHerbalNewMember(this.value);
  adjustQtySelectOptions(this.value);
});

function checkHerbalNewMember(selectedValue) {
  const val = selectedValue.trim();
  if (val.includes('è‰æœ¬') && val.includes('æ–°å…¥æœƒ')) {
    setTimeout(() => {
      alert('ğŸ“‹ æ–°å…¥æœƒè‰æœ¬çµ„åˆæé†’ï¼š\n\nç”·ç”Ÿæ¬¾ï¼š211x2 + 101x2\nå¥³ç”Ÿæ¬¾ï¼š211x2 + 707x2\n\nè«‹åˆ†åˆ¥æ–°å¢å°æ‡‰å“é …èˆ‡æ•¸é‡');
    }, 100);
  }
}

function adjustQtySelectOptions(selectedValue) {
  const val = selectedValue.trim();
  let maxQty = 99;
  if (val.includes('æ–°å…¥æœƒ') || val.includes('æ–°æœƒå“¡') || val.includes('å…¥æœƒ')) {
    maxQty = 1;
  } else if (val.includes('2711AB') && val.includes('(4)')) {
    maxQty = 2;
  }
  qtyInput.innerHTML = '';
  for (let i = 1; i <= maxQty; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = i;
    qtyInput.appendChild(option);
  }
}

function loadSelectedProds() {
  const saved = localStorage.getItem('selectedProducts');
  if (saved) {
    selectedProds = JSON.parse(saved);
    renderTable();
  }
}

function saveSelectedProds() {
  localStorage.setItem('selectedProducts', JSON.stringify(selectedProds));
}

function saveUserUsageRecord() {
  localStorage.setItem('userUsageRecord', JSON.stringify(userUsageRecord));
}

function setupLineName() {
  lineName = localStorage.getItem('lineName') || userInfo?.displayName || '';
  if (!lineName || lineName === 'æœªçŸ¥ç”¨æˆ¶å') {
    const input = prompt('è«‹è¼¸å…¥æ‚¨çš„ã€è©¦ç®—è€…åç¨±ã€\nï¼ˆåƒ…éœ€è¼¸å…¥ä¸€æ¬¡ï¼Œå¯éš¨æ™‚é‡ç½®ï¼‰ï¼š');
    if (input && input.trim()) {
      lineName = input.trim();
      localStorage.setItem('lineName', lineName);
    } else {
      lineName = 'æœªè¨­å®š';
    }
  }
  calculatorDisplay.value = lineName;
}

function resetLineName() {
  if (confirm('ç¢ºå®šè¦é‡ç½®è©¦ç®—è€…åç¨±å—ï¼Ÿ')) {
    localStorage.removeItem('lineName');
    setupLineName();
    showToast('è©¦ç®—è€…åç¨±å·²é‡ç½®');
  }
}

function syncRecordResetToBackend() {
  return new Promise((resolve, reject) => {
    if (!userInfo || authStatus.isVip || authStatus.isSuperAdmin) {
      resolve(true);
      return;
    }
    const data = {
      action: 'recordReset',
      userId: userInfo.userId,
      displayName: userInfo.displayName,
      callback: 'recordResetCallback',
      dataType: 'resetRecord'
    };
    $.ajax({
      url: API_URL,
      dataType: 'jsonp',
      jsonp: 'callback',
      jsonpCallback: 'recordResetCallback',
      timeout: JSONP_TIMEOUT,
      data: data,
      success: function(resp) {
        if (resp.status === "success") {
          const backendUsageCount = resp.usageCount || 0;
          userUsageRecord[userInfo.userId] = backendUsageCount;
          saveUserUsageRecord();
          authStatus.remainingTimes = MAX_NORMAL_USER_USAGE - backendUsageCount;
          updateAuthStatusBar();
          checkUserRemainingTimes();
          resolve(true);
        } else {
          showToast(`å¾Œç«¯æ‰£æ¬¡å¤±æ•—ï¼š${resp.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
          resolve(false);
        }
      },
      error: function(xhr, status, error) {
        const errorMsg = status === 'timeout' ? 'æ‰£æ¬¡åŒæ­¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡' : `æ‰£æ¬¡åŒæ­¥å¤±æ•—ï¼š${error}`;
        showToast(errorMsg, 'error');
        reject(new Error(errorMsg));
      }
    });
  });
}

async function resetReport() {
  if (!authStatus || authStatus.isExpired) return;
  if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å“é …è¨˜éŒ„å—ï¼Ÿ')) return;
  
  const isPrivilegeUser = authStatus.isVip || authStatus.isSuperAdmin;
  let isDeducted = false;
  
  if (!isPrivilegeUser && authStatus.remainingTimes > 0) {
    resetReportBtn.disabled = true;
    resetReportBtn.textContent = "è™•ç†ä¸­...";
    try {
      const syncSuccess = await syncRecordResetToBackend();
      isDeducted = syncSuccess;
    } catch (error) {
      showToast(error.message, 'error');
    } finally {
      resetReportBtn.disabled = false;
      resetReportBtn.textContent = "ğŸ”„ é‡ç½®å ±è¡¨";
    }
  }
  
  selectedProds = [];
  saveSelectedProds();
  renderTable();
  adjustQtySelectOptions(nameInput.value);
  
  if (isDeducted) {
    showToast(`âœ… å·²æ‰£é™¤1æ¬¡ä½¿ç”¨æ¬¡æ•¸ï¼Œå‰©é¤˜${authStatus.remainingTimes}/${MAX_NORMAL_USER_USAGE}æ¬¡`, 'warning');
  } else {
    showToast('å ±è¡¨å·²é‡ç½®');
  }
}

async function loadProducts() {
  try {
    const res = await fetch(`${API_URL}?action=all`);
    const data = await res.json();
    products = data;
    nameInput.innerHTML = "";
    data.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.name;
      opt.textContent = item.name;
      nameInput.appendChild(opt);
    });
    setTimeout(() => {
      checkHerbalNewMember(nameInput.value);
      adjustQtySelectOptions(nameInput.value);
    }, 300);
  } catch (error) {
    showToast(`è®€å–å•†å“å¤±æ•—: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
  }
}

function renderTable() {
  reportBody.innerHTML = "";
  let totalPrice = 0, totalPv = 0;
  selectedProds.forEach((item, idx) => {
    const val = item.name.trim();
    let maxQty = 99;
    if (val.includes('æ–°å…¥æœƒ') || val.includes('æ–°æœƒå“¡') || val.includes('å…¥æœƒ')) {
      maxQty = 1;
      if (item.qty > maxQty) {
        item.qty = maxQty;
        saveSelectedProds();
      }
    } else if (val.includes('2711AB') && val.includes('(4)')) {
      maxQty = 2;
      if (item.qty > maxQty) {
        item.qty = maxQty;
        saveSelectedProds();
      }
    }
    const subtotalPrice = item.price * item.qty;
    const subtotalPv = item.pv * item.qty;
    totalPrice += subtotalPrice;
    totalPv += subtotalPv;
    const tr = document.createElement("tr");
    const qtyOptions = Array.from({ length: maxQty }, (_, i) => {
      const val = i + 1;
      return `<option value="${val}" ${val === item.qty ? "selected" : ""}>${val}</option>`;
    }).join("");
    tr.innerHTML = `
      <td style="text-align:center;">${item.name}</td>
      <td>
        <select class="qtySelect" data-index="${idx}" style="text-align:center;">
          ${qtyOptions}
        </select>
      </td>
      <td style="text-align:center;">${item.price}</td>
      <td style="text-align:center;">${item.pv}</td>
      <td style="text-align:center;">${subtotalPrice}</td>
      <td style="text-align:center;">${subtotalPv}</td>
      <td><button class="deleteBtn" data-index="${idx}">åˆªé™¤</button></td>
    `;
    reportBody.appendChild(tr);
  });
  totalPriceCellDup.textContent = totalPrice;
  totalPvCellDup.textContent = totalPv;
  const diff1 = TARGET_PV112 - totalPv;
  const diff2 = TARGET_PV220 - totalPv;
  pvDiff.textContent = diff1 > 0 ? diff1 : 0;
  pvDiff2.textContent = diff2 > 0 ? diff2 : 0;
  pvMessage1.innerHTML = totalPv >= TARGET_PV112 ? '<span class="done">ğŸ‰ å·²é”æ¨™</span>' : '';
  pvMessage2.innerHTML = totalPv >= TARGET_PV220 ? '<span class="done">ğŸ‰ å·²é”æ¨™</span>' : '';
  
  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.onclick = e => {
      const idx = parseInt(e.target.dataset.index);
      selectedProds.splice(idx, 1);
      saveSelectedProds();
      renderTable();
    };
  });
  document.querySelectorAll(".qtySelect").forEach(select => {
    select.onchange = e => {
      const idx = parseInt(e.target.dataset.index);
      selectedProds[idx].qty = parseInt(e.target.value);
      saveSelectedProds();
      renderTable();
    };
  });
}

function addProduct() {
  if (!authStatus) {
    showToast('è«‹å…ˆå®Œæˆç”¨æˆ¶æ¬Šé™é©—è­‰', 'error');
    return;
  }
  const isPrivilegeUser = authStatus.isVip || authStatus.isSuperAdmin;
  if (!isPrivilegeUser && authStatus.remainingTimes <= 0) {
    showToast(`æ™®é€šç”¨æˆ¶ä½¿ç”¨æ¬¡æ•¸å·²é”ä¸Šé™ï¼ˆ${MAX_NORMAL_USER_USAGE}æ¬¡ï¼‰ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡å‡ç´š`, 'error');
    return;
  }
  const selectedName = nameInput.value;
  let qty = parseInt(qtyInput.value);
  if (!selectedName || qty <= 0) {
    alert("è«‹é¸æ“‡å“é …èˆ‡æ•¸é‡");
    return;
  }
  const val = selectedName.trim();
  let maxQty = 99;
  if (val.includes('æ–°å…¥æœƒ') || val.includes('æ–°æœƒå“¡') || val.includes('å…¥æœƒ')) {
    maxQty = 1;
    if (qty > maxQty) {
      alert(`âš ï¸ æ–°å…¥æœƒç›¸é—œå“é …é™è³¼${maxQty}å€‹ï¼Œå·²è‡ªå‹•èª¿æ•´æ•¸é‡ç‚º${maxQty}`);
      qty = maxQty;
    }
  } else if (val.includes('2711AB') && val.includes('(4)')) {
    maxQty = 2;
    if (qty > maxQty) {
      alert(`âš ï¸ 2711AB(4)é™è³¼${maxQty}çµ„ï¼Œå·²è‡ªå‹•èª¿æ•´æ•¸é‡ç‚º${maxQty}`);
      qty = maxQty;
    }
  }
  const product = products.find(p => p.name === selectedName);
  if (!product) {
    alert("æ‰¾ä¸åˆ°è©²å“é …");
    return;
  }
  const exists = selectedProds.find(p => p.name === selectedName);
  if (exists) {
    const totalQty = exists.qty + qty;
    if (totalQty > maxQty) {
      alert(`âš ï¸ è©²å“é …é™è³¼${maxQty}å€‹/çµ„ï¼Œç›®å‰å·²é¸${exists.qty}å€‹/çµ„ï¼Œç„¡æ³•å†æ–°å¢`);
      return;
    }
    exists.qty += qty;
  } else {
    selectedProds.push({ ...product, qty });
  }
  saveSelectedProds();
  renderTable();
  if (!isPrivilegeUser) {
    recordUserUsage();
    checkUserRemainingTimes();
  }
}

function checkUserRemainingTimes() {
  if (!authStatus) return false;
  const isPrivilegeUser = authStatus.isVip || authStatus.isSuperAdmin;
  if (authStatus.isExpired) {
    exportBtn.disabled = true;
    addBtn.disabled = true;
    shareToLineBtn.disabled = true;
    resetReportBtn.disabled = true;
    return false;
  }
  if (isPrivilegeUser) {
    exportBtn.disabled = false;
    addBtn.disabled = false;
    shareToLineBtn.disabled = false;
    resetReportBtn.disabled = false;
    return true;
  }
  const userId = userInfo.userId;
  const usedTimes = userUsageRecord[userId] || 0;
  authStatus.remainingTimes = MAX_NORMAL_USER_USAGE - usedTimes;
  updateAuthStatusBar();
  if (authStatus.remainingTimes <= 0) {
    exportBtn.disabled = true;
    addBtn.disabled = true;
    shareToLineBtn.disabled = true;
    resetReportBtn.disabled = true;
    return false;
  } else {
    exportBtn.disabled = false;
    addBtn.disabled = false;
    shareToLineBtn.disabled = false;
    resetReportBtn.disabled = false;
    return true;
  }
}

function recordUserUsage() {
  if (!authStatus) return;
  const isPrivilegeUser = authStatus.isVip || authStatus.isSuperAdmin;
  if (isPrivilegeUser) return;
  const userId = userInfo.userId;
  const beforeRemaining = authStatus.remainingTimes;
  if (beforeRemaining <= 0) return;
  userUsageRecord[userId] = (userUsageRecord[userId] || 0) + 1;
  saveUserUsageRecord();
  authStatus.remainingTimes = MAX_NORMAL_USER_USAGE - userUsageRecord[userId];
  updateAuthStatusBar();
}

function updateAuthStatusBar() {
  if (!authStatus || !userInfo) return;
  let statusHtml = '';
  if (authStatus.isSuperAdmin) {
    const expiryText = authStatus.remainingDays === "æ°¸ä¹…æœ‰æ•ˆ" 
      ? "æ°¸ä¹…æœ‰æ•ˆ" 
      : `${authStatus.displayExpiryDate} | å‰©é¤˜ï¼š<span class="remaining-days-yellow">${authStatus.remainingDays}</span>`;
    statusHtml = `
      <span class="super-admin">ğŸ‘‘ è¶…ç´šç®¡ç†å“¡ ğŸ‘‘</span> | 
      ç”¨æˆ¶åï¼š<span class="super-admin-username">${userInfo.displayName}</span>
      <br/>æœ‰æ•ˆæœŸé™ï¼š${expiryText}
    `;
  } else if (authStatus.isVip) {
    const expiryText = authStatus.remainingDays === "æ°¸ä¹…æœ‰æ•ˆ" 
      ? "æ°¸ä¹…æœ‰æ•ˆ" 
      : `${authStatus.displayExpiryDate} | å‰©é¤˜ï¼š<span class="remaining-days-yellow">${authStatus.remainingDays}</span>`;
    statusHtml = `
      <span class="vip-admin">ğŸ’ å°Šçˆµç”¨æˆ¶ ğŸ’</span> | 
      ç”¨æˆ¶åï¼š<span class="vip-admin-username">${userInfo.displayName}</span>
      <br/>æœ‰æ•ˆæœŸé™ï¼š${expiryText}
    `;
  } else {
    statusHtml = `
      <span class="normal">ğŸª™ æ™®é€šç”¨æˆ¶ ğŸª™</span> | 
      ç”¨æˆ¶åï¼š${userInfo.displayName}
      <br/>å‰©é¤˜ä½¿ç”¨æ¬¡æ•¸ï¼š<span class="${authStatus.remainingTimes <= 0 ? 'expired' : 'normal'}">${authStatus.remainingTimes || 0}/${MAX_NORMAL_USER_USAGE}æ¬¡</span>
    `;
  }
  authStatusBar.innerHTML = statusHtml;
  authStatusBar.style.display = 'block';
}

exportBtn.addEventListener("click", async () => {
  if (!checkUserRemainingTimes()) return;
  if (selectedProds.length === 0) {
    alert("è«‹å…ˆæ–°å¢è‡³å°‘ä¸€å€‹å“é …ï¼Œæ‰èƒ½åŒ¯å‡ºåœ–ç‰‡ï¼");
    return;
  }
  exportBtn.disabled = true;
  exportBtn.textContent = "åŒ¯å‡ºä¸­...";
  const opCells = document.querySelectorAll("#reportTable td:last-child, #reportTable th:last-child");
  opCells.forEach(el => el.style.display = "none");
  try {
    const canvas = await html2canvas(document.getElementById("captureArea"), {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: null,
      logging: false,
      letterRendering: true,
      useTransform: true
    });
    const dataUrl = canvas.toDataURL("image/png");
    previewImage.src = dataUrl;
    previewImage.style.display = "block";
    shareToLineBtn.style.display = "inline-block";
    nativeShareBtn.style.display = navigator.share ? "inline-block" : "none";
    clearImageBtn.style.display = "inline-block";
    if (!authStatus.isVip && !authStatus.isSuperAdmin) {
      recordUserUsage();
      checkUserRemainingTimes();
    }
  } catch (error) {
    showToast(`åŒ¯å‡ºå¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
  } finally {
    opCells.forEach(el => el.style.display = "");
    exportBtn.disabled = false;
    exportBtn.textContent = "ğŸ“¤ å ±è¡¨è½‰åœ–ç‰‡";
  }
});

shareToLineBtn.addEventListener("click", async () => {
  if (!authStatus) return;
  if (!previewImage.src) {
    alert("è«‹å…ˆåŒ¯å‡ºåœ–ç‰‡");
    return;
  }
  shareToLineBtn.disabled = true;
  shareToLineBtn.textContent = "ä¸Šå‚³ä¸­...";
  try {
    const base64Data = previewImage.src.split(",")[1];
    const formData = new FormData();
    formData.append("image", base64Data);
    formData.append("key", IMGBB_API_KEY);
    const res = await fetch("https://api.imgbb.com/1/upload", {
      method: "POST",
      body: formData,
    });
    const result = await res.json();
    if (result.success) {
      const imageUrl = result.data.url;
      const buyerName = buyerInput.value.trim() || "æœªå¡«";
      const calculatorName = lineName || "æœªè¨­å®š";
      const lineShareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(
        `åº·åœ’è©¦ç®—å ±è¡¨\n\nè³¼è²·è€…ï¼š${buyerName}\nè©¦ç®—è€…ï¼š${calculatorName}\n${imageUrl}`
      )}`;
      window.open(lineShareUrl, "_blank");
      showToast("âœ… åœ–ç‰‡å·²ä¸Šå‚³å‚™ä»½");
    } else {
      showToast("åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", 'error');
    }
  } catch (error) {
    showToast(`åœ–ç‰‡ä¸Šå‚³éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
  } finally {
    shareToLineBtn.disabled = false;
    shareToLineBtn.textContent = "ğŸ“© ä¸Šå‚³å‚™ä»½";
  }
});

nativeShareBtn.addEventListener("click", async () => {
  if (!authStatus) return;
  if (!navigator.share || !previewImage.src) {
    alert("ç„¡æ³•ä½¿ç”¨åŸç”Ÿåˆ†äº«");
    return;
  }
  try {
    const response = await fetch(previewImage.src);
    const blob = await response.blob();
    const filesArray = [new File([blob], "åº·åœ’è©¦ç®—å ±è¡¨.png", { type: blob.type })];
    const buyer = buyerInput.value.trim() || "æœªå¡«";
    const calculator = lineName || "æœªè¨­å®š";
    const shareText = `åº·åœ’è©¦ç®—å ±è¡¨\nè³¼è²·è€…ï¼š${buyer}\nè©¦ç®—è€…ï¼š${calculator}`;
    await navigator.share({
      files: filesArray,
      title: "åº·åœ’è©¦ç®—å ±è¡¨",
      text: shareText,
    });
  } catch (error) {
    showToast(`åˆ†äº«å¤±æ•—: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
  }
});

clearImageBtn.addEventListener("click", () => {
  previewImage.style.display = "none";
  previewImage.src = "";
  shareToLineBtn.style.display = "none";
  nativeShareBtn.style.display = "none";
  clearImageBtn.style.display = "none";
});

function showToast(message, type = 'success') {
  toast.textContent = message;
  toast.className = 'toast';
  toast.classList.add(type);
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 3000);
}

const calculateRemainingDaysByDate = (expiryDateStr) => {
  try {
    if (expiryDateStr === PERMANENT_EXPIRY_DATE) return {
      displayDate: "æ°¸ä¹…æœ‰æ•ˆ",
      remainingDays: "æ°¸ä¹…æœ‰æ•ˆ",
      isExpired: false
    };
    const dateReg = /^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/;
    if (!dateReg.test(expiryDateStr)) return {
      displayDate: "æ ¼å¼éŒ¯èª¤",
      remainingDays: "æ ¼å¼éŒ¯èª¤",
      isExpired: true
    };
    const dateParts = expiryDateStr.replace(/-/g, '/').split('/').map(Number);
    const [year, month, day] = dateParts;
    const expiryDate = new Date(year, month - 1, day, 23, 59, 59, 999);
    const now = new Date();
    if (isNaN(expiryDate.getTime())) return {
      displayDate: "æ—¥æœŸç„¡æ•ˆ",
      remainingDays: "æ—¥æœŸç„¡æ•ˆ",
      isExpired: true
    };
    const oneDayMs = 1000 * 3600 * 24;
    const timeDiff = expiryDate.getTime() - now.getTime();
    let dayDiff = Math.ceil(timeDiff / oneDayMs);
    const fmtMonth = String(month).padStart(2, '0');
    const fmtDay = String(day).padStart(2, '0');
    const displayDate = `${year}/${fmtMonth}/${fmtDay}`;
    let remainingDaysText, isExpired = false;
    if (timeDiff < 0) {
      remainingDaysText = "<span class='expired'>å·²éæœŸ</span>";
      isExpired = true;
    } else if (dayDiff === 0) {
      remainingDaysText = "<span class='warning'>æœ€å¾Œ1å¤©</span>";
      isExpired = false;
    } else if (dayDiff <= 30) {
      remainingDaysText = `<span class='warning'>${dayDiff} å¤©</span>`;
      isExpired = false;
    } else {
      remainingDaysText = `${dayDiff} å¤©`;
      isExpired = false;
    }
    return { displayDate, remainingDays: remainingDaysText, isExpired };
  } catch (e) {
    return {
      displayDate: "è¨ˆç®—éŒ¯èª¤",
      remainingDays: "è¨ˆç®—éŒ¯èª¤",
      isExpired: true
    };
  }
};

const showError = (msg) => {
  authLoading.style.display = 'none';
  captureArea.style.display = 'none';
  inputArea.style.display = 'none';
  buttonGroup.style.display = 'none';
  errorContent.innerHTML = `<p class="font-medium">${msg}</p>
    <div class="mt-3 flex justify-center">
      <button onclick="window.location.reload()" class="text-white hover:text-[#fff]">
        é‡æ–°å˜—è©¦
      </button>
    </div>`;
  errorMessage.style.display = 'block';
};

const verifyUserFromBackend = (profile) => {
  return new Promise((resolve, reject) => {
    const decodedToken = liff.getDecodedIDToken();
    const userId = profile.userId || decodedToken?.sub || "";
    const displayName = profile.displayName || 'LINEç”¨æˆ¶';
    const data = {
      action: 'verifyUser',
      userId: userId,
      displayName: displayName,
      callback: 'verifyCallback',
      dataType: 'userVerify'
    };
    $.ajax({
      url: API_URL,
      dataType: 'jsonp',
      jsonp: 'callback',
      jsonpCallback: 'verifyCallback',
      timeout: JSONP_TIMEOUT,
      data: data,
      success: function (resp) {
        if (resp.status === "success") {
          const backendUsageCount = resp.usageCount || 0;
          userUsageRecord[userId] = backendUsageCount;
          saveUserUsageRecord();
          const expiryData = calculateRemainingDaysByDate(resp.expiryDate || PERMANENT_EXPIRY_DATE);
          resolve({
            ...resp,
            displayName: displayName,
            remainingDays: expiryData.remainingDays,
            displayExpiryDate: expiryData.displayDate,
            isExpired: expiryData.isExpired,
            isVip: resp.isVip === true,
            isSuperAdmin: resp.isSuperAdmin === true,
            remainingTimes: resp.remainingTimes || (MAX_NORMAL_USER_USAGE - backendUsageCount)
          });
        } else {
          showError(resp.message || "ç”¨æˆ¶é©—è­‰å¤±æ•—");
          resolve(null);
        }
      },
      error: function (xhr, status, error) {
        const errorMsg = status === 'timeout' 
          ? 'é©—è­‰è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡æ–°å˜—è©¦' 
          : `é©—è­‰å¤±æ•—ï¼š${error || 'æœªçŸ¥ç¶²çµ¡éŒ¯èª¤'}`;
        showError(errorMsg);
        reject(new Error(errorMsg));
      }
    });
  });
};

window.verifyCallback = function (resp) {};
window.recordResetCallback = function (resp) {};

async function initLiffAndAuth() {
  try {
    updateAuthLoadingText("æ­£åœ¨åˆå§‹åŒ–LINEç™»éŒ„", "è«‹ç¨å€™...");
    await liff.init({ 
      liffId: LIFF_ID,
      withLoginOnExternalBrowser: true,
      scope: 'profile openid email'
    });
    loadProducts();
    
    if (!liff.isLoggedIn()) {
      updateAuthLoadingText("è«‹å…ˆç™»éŒ„LINEè³¬è™Ÿ", "å°‡è‡ªå‹•è·³è½‰è‡³ç™»éŒ„é é¢...");
      liff.login({ redirectUri: window.location.href });
      return;
    }
    const profile = await liff.getProfile();
    userInfo = {
      userId: profile.userId,
      displayName: profile.displayName
    };
    updateAuthLoadingText("æ­£åœ¨é©—è­‰æˆæ¬Šç‹€æ…‹", "æ ¸å°ç”¨æˆ¶æ¬Šé™ä¸­...");
    const authData = await verifyUserFromBackend(profile);
    if (!authData) return;
    if (authData.isExpired) {
      showError('æ‚¨çš„è³¬è™Ÿå·²éæœŸï¼Œç„¡æ³•ç™»éŒ„è©¦ç®—ç³»çµ±ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡çºŒæœŸ');
      return;
    }
    authStatus = {
      isVip: authData.isVip,
      isSuperAdmin: authData.isSuperAdmin,
      remainingDays: authData.remainingDays,
      displayExpiryDate: authData.displayExpiryDate,
      expiryDate: authData.expiryDate,
      usageCount: authData.usageCount || 0,
      isExpired: authData.isExpired,
      remainingTimes: authData.remainingTimes || 0
    };
    authLoading.style.display = 'none';
    captureArea.style.display = 'block';
    inputArea.style.display = 'flex';
    buttonGroup.style.display = 'flex';
    setupLineName();
    loadSelectedProds();
    checkUserRemainingTimes();
    updateAuthStatusBar();
    showToast(`æ­¡è¿å›ä¾†ï¼Œ${userInfo.displayName}ï¼`);
  } catch (error) {
    const errorMsg = error.message || 'æœªçŸ¥åˆå§‹åŒ–éŒ¯èª¤';
    updateAuthLoadingText("åˆå§‹åŒ–å¤±æ•—", errorMsg + "<br/>è«‹åˆ·æ–°é é¢é‡è©¦");
    showToast(`åˆå§‹åŒ–å¤±æ•—ï¼š${errorMsg}`, 'error');
  }
}

function updateAuthLoadingText(title, desc) {
  if (authLoadingTitle) authLoadingTitle.textContent = title;
  if (authLoadingDesc) authLoadingDesc.innerHTML = desc;
}

window.addEventListener('resize', () => {
  const table = document.getElementById('reportTable');
  table.style.fontSize = window.innerWidth < 360 ? '10px' : '11px';
});

function initApp() {
  if (window.jQuery) {
    initLiffAndAuth();
  } else {
    let waitCount = 0;
    const interval = setInterval(() => {
      waitCount++;
      if (window.jQuery || waitCount >= 50) {
        clearInterval(interval);
        window.jQuery ? initLiffAndAuth() : (
          updateAuthLoadingText("jQueryåŠ è¼‰å¤±æ•—", "è«‹æª¢æŸ¥ç¶²çµ¡æˆ–åˆ·æ–°é é¢"),
          showToast('jQueryåŠ è¼‰å¤±æ•—', 'error')
        );
      }
    }, 100);
  }
}

addBtn.addEventListener("click", addProduct);
resetCalculatorBtn.addEventListener("click", resetLineName);
resetReportBtn.addEventListener("click", resetReport);
window.onload = initApp;
  </script>
</body>
</html>

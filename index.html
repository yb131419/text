<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LIFF 登錄到 Google Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- jQuery for JSONP -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h2>LIFF 登錄測試</h2>
  <div id="status">正在初始化 LIFF...</div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // 初始化 LIFF
      liff.init({ liffId: "2007488640-PbB48ELN" })
        .then(() => {
          if (!liff.isLoggedIn()) {
            document.getElementById("status").innerText = "尚未登入，重新導向 LINE 登入...";
            liff.login();
          } else {
            document.getElementById("status").innerText = "已登入，正在取得使用者資訊...";

            // 取得使用者資料
            liff.getProfile().then(profile => {
              var userId = profile.userId;
              var displayName = profile.displayName;

              document.getElementById("status").innerText = 
                "歡迎 " + displayName + " (userId: " + userId + ")，資料上傳中...";

              // JSONP 呼叫 GAS
              $.ajax({
                url: "https://script.google.com/macros/s/AKfycbxsl-llg3RMZZkLnje8Qq4eQNg6lK869zq5f44EMATyHMmnV_5K_6RnSbzUUGbOevqm/exec",
                dataType: "jsonp",
                data: {
                  callback: "callbackFunc",
                  userId: userId,
                  displayName: displayName
                }
              });
            }).catch(err => {
              console.error("getProfile 錯誤:", err);
              document.getElementById("status").innerText = "取得資料失敗: " + err;
            });
          }
        })
        .catch(err => {
          console.error("LIFF init 錯誤:", err);
          document.getElementById("status").innerText = "LIFF 初始化錯誤: " + err;
        });
    });

    // JSONP callback
    function callbackFunc(response) {
      console.log("GAS 回應:", response);
      if (response.status === "success") {
        document.getElementById("status").innerText = "✅ 登錄成功，資料已存到 Google Sheet！";
      } else {
        document.getElementById("status").innerText = "❌ 登錄失敗: " + response.message;
      }
    }
  </script>
</body>
</html>
